<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>【UE5】多人联机TPS游戏开发（一） ——  制作联机插件 | Keshiki's Blog</title><meta name="author" content="Keshiki"><meta name="copyright" content="Keshiki"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="【UE5】多人联机TPS游戏开发（一） ——  制作联机插件 前言： 本来准备继续深入学习GAS系统的，但是被学院弄去实训一个月后对前面学的东西有点陌生了，而且到7月还没找到实习，准备直接秋招了，所以想先把网络相关的内容学起来。 网络部分是我在之前的学习中完全没有接触过的内容，当看到两个角色出现在一张地图中并且可以进行互动的时候感觉还是挺有意思的。当然这个项目中使用的方法比较有局限性，但是从中学习">
<meta property="og:type" content="article">
<meta property="og:title" content="【UE5】多人联机TPS游戏开发（一） ——  制作联机插件">
<meta property="og:url" content="https://www.keshiki.top/undefined/f18ea7eb.html">
<meta property="og:site_name" content="Keshiki&#39;s Blog">
<meta property="og:description" content="【UE5】多人联机TPS游戏开发（一） ——  制作联机插件 前言： 本来准备继续深入学习GAS系统的，但是被学院弄去实训一个月后对前面学的东西有点陌生了，而且到7月还没找到实习，准备直接秋招了，所以想先把网络相关的内容学起来。 网络部分是我在之前的学习中完全没有接触过的内容，当看到两个角色出现在一张地图中并且可以进行互动的时候感觉还是挺有意思的。当然这个项目中使用的方法比较有局限性，但是从中学习">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://www.keshiki.top/img/avatar.png">
<meta property="article:published_time" content="2025-07-04T16:00:00.000Z">
<meta property="article:modified_time" content="2025-08-13T17:44:24.213Z">
<meta property="article:author" content="Keshiki">
<meta property="article:tag" content="Keshiki,Keshiki&#39;s Blog,Keshiki的博客,博客,Blog,blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.keshiki.top/img/avatar.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "【UE5】多人联机TPS游戏开发（一） ——  制作联机插件",
  "url": "https://www.keshiki.top/undefined/f18ea7eb.html",
  "image": "https://www.keshiki.top/img/avatar.png",
  "datePublished": "2025-07-04T16:00:00.000Z",
  "dateModified": "2025-08-13T17:44:24.213Z",
  "author": [
    {
      "@type": "Person",
      "name": "Keshiki",
      "url": "https://www.keshiki.top/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://www.keshiki.top/undefined/f18ea7eb.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="manifest" href="/manifest.json"/><meta name="msapplication-TileColor" content="#39C5BB"/><link rel="apple-touch-icon" sizes="180x180" href="/img/siteicon/128.png"/><link rel="icon" type="image/png" sizes="32x32" href="/img/siteicon/32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/img/siteicon/16.png"/><link rel="mask-icon" href="/img/siteicon/128.png" color="#5bbad5"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '【UE5】多人联机TPS游戏开发（一） ——  制作联机插件',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://cdn.cbd.int/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Keshiki's Blog" type="application/atom+xml">
</head><body><div id="web_bg" style="background-image: url(https://s21.ax1x.com/2024/12/11/pAbSVg0.jpg);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">11</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/bangumis/index.html"><i class="fa-fw fas fa-home"></i><span> 追番</span></a></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-envelope"></i><span> 留言板</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Keshiki's Blog</span></a><a class="nav-page-title" href="/"><span class="site-name">【UE5】多人联机TPS游戏开发（一） ——  制作联机插件</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/bangumis/index.html"><i class="fa-fw fas fa-home"></i><span> 追番</span></a></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-envelope"></i><span> 留言板</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">【UE5】多人联机TPS游戏开发（一） ——  制作联机插件</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-07-04T16:00:00.000Z" title="发表于 2025-07-05 00:00:00">2025-07-05</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-08-13T17:44:24.213Z" title="更新于 2025-08-14 01:44:24">2025-08-14</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="【UE5】多人联机TPS游戏开发（一）-——-制作联机插件"><a href="#【UE5】多人联机TPS游戏开发（一）-——-制作联机插件" class="headerlink" title="【UE5】多人联机TPS游戏开发（一） ——  制作联机插件"></a>【UE5】多人联机TPS游戏开发（一） ——  制作联机插件</h1><blockquote>
<p>前言：</p>
<p>本来准备继续深入学习GAS系统的，但是被学院弄去实训一个月后对前面学的东西有点陌生了，而且到7月还没找到实习，准备直接秋招了，所以想先把网络相关的内容学起来。</p>
<p>网络部分是我在之前的学习中完全没有接触过的内容，当看到两个角色出现在一张地图中并且可以进行互动的时候感觉还是挺有意思的。当然这个项目中使用的方法比较有局限性，但是从中学习到的一些理念和框架也足够我初步了解并动手实现网络联机了。</p>
<p>又是一段艰难的旅程，但是也没办法，谁让我就是头铁要走这条路呢~</p>
</blockquote>
<h2 id="1-联机基础"><a href="#1-联机基础" class="headerlink" title="1.联机基础"></a>1.联机基础</h2><p>联机游戏的本质，是<strong>在多台设备上运行的多个游戏实例之间建立状态同步</strong>。为了保证所有玩家在同一个“游戏世界”中实时互动，这些实例必须通过网络通信同步位置、输入、事件等关键数据。联机的方式大概可以分为两类：<strong><code>Peer-to-Peer(P2P)</code></strong>和<strong><code>Client-Server(CS)</code></strong>。</p>
<p>在<code>P2P</code>架构中，所有玩家都需要时刻向其他所有玩家发送自己的信息，而发送信息的数量会随着玩家数量的增加而快速增长，因此这是一种<strong>简单但局限性极大</strong>的方式。</p>
<p><code>Client-Server</code>架构则是存在一个服务器，所有玩家只需要和服务器进行通信，服务器会接收所有玩家的信息，并向所有玩家同步这些信息。<code>CS</code>架构又可以分为两类：<strong><code>Listen-Server</code>（监听服务器）</strong>，一台玩家主机既运行游戏客户端，也承担服务器角色。主机上的逻辑会被当作权威状态，服务器会把必要的状态（位置、事件等）同步到连接的客户端。这种方法使用于网络传输需求较小的游戏。个人猜测<code>Warframe</code>就是使用了这种方式；<strong><code>Dedicated-Server</code>（专用服务器）</strong>，有一个专门的服务器负责接收请求并发送数据，通常用于对网络要求较高的游戏，如大型MMO、战术射击游戏等。</p>
<p>本项目使用的是收听服务器的方式进行联机。在实现联机功能时，一个主要挑战是<strong>如何对接各个平台（Steam、Epic、Xbox、PS 等）的底层 API</strong>。每个平台的网络服务机制不同，实现方式也不统一。为了解决这个问题，Unreal 提供了一个跨平台的抽象层 —— <strong><code>OnlineSubsystem</code>（简称 OSS）</strong>。OSS 为开发者屏蔽了平台差异，使我们可以使用统一的接口来实现会话创建、玩家身份识别、好友系统等功能。</p>
<p>本项目使用的是 OSS 中的 <strong><code>OnlineSubsystemSteam</code>插件</strong>，通过 Steam 提供的 API 实现跨局域网的联机功能。</p>
<h3 id="1-1-测试局域网联机"><a href="#1-1-测试局域网联机" class="headerlink" title="1.1 测试局域网联机"></a>1.1 测试局域网联机</h3><p>首先进行联机功能的第一步，也是最简单的一步：实现局域网联机。</p>
<p>创建一个第三人称项目，并创建一个名为“Lobby”的关卡。在角色蓝图中实现以下功能：</p>
<p><img src="/undefined/f18ea7eb/image-20250704221601626.png" alt="image-20250704221601626"></p>
<p>打包项目，并将其拷贝到客机。客机需要和主机连接到同一局域网。</p>
<p>在主机按下“1”后，主机会加载关卡“Lobby”，Options中的“listen”表明要以<strong>监听服务器</strong>身份运行，它会打开 socket 接口等待其他玩家连接。随后在客机按下”2“，游戏会执行命令“Open 121.48.198.53”，客户端尝试通过 socket 连接到该地址运行的 listen server。如果目标IP是监听服务器，它会接受连接，并将客户端加载到正确的地图中。</p>
<p>完成上面的操作后，就可以看到两台电脑的角色在一起活蹦乱跳了。</p>
<p><img src="/undefined/f18ea7eb/image-20250704222653264.png" alt="image-20250704222653264"></p>
<h3 id="1-2-使用代码实现局域网联机"><a href="#1-2-使用代码实现局域网联机" class="headerlink" title="1.2 使用代码实现局域网联机"></a>1.2 使用代码实现局域网联机</h3><p>逻辑很简单，直接贴代码。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">AMPTestingCharacter::OpenLobby</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UWorld* world = <span class="built_in">GetWorld</span>();</span><br><span class="line">	<span class="keyword">if</span> (world) &#123;</span><br><span class="line">		world-&gt;<span class="built_in">ServerTravel</span>(<span class="string">&quot;/Game/ThirdPerson/Maps/Lobby?Listen&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">AMPTestingCharacter::CallOpenLevel</span><span class="params">(<span class="type">const</span> FString&amp; Address)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UGameplayStatics::<span class="built_in">OpenLevel</span>(<span class="keyword">this</span>, *Address);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">AMPTestingCharacter::CallClientTravel</span><span class="params">(<span class="type">const</span> FString&amp; Address)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	APlayerController* playerController = <span class="built_in">GetGameInstance</span>()-&gt;<span class="built_in">GetFirstLocalPlayerController</span>();</span><br><span class="line">	<span class="keyword">if</span> (playerController) &#123;</span><br><span class="line">		playerController-&gt;<span class="built_in">ClientTravel</span>(Address, ETravelType::TRAVEL_Absolute);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>逻辑和上一小节基本上是一样的，只不过多了一种用于连接主机的方法。用相同的方式进行测试。</p>
<p><img src="/undefined/f18ea7eb/image-20250704222414649.png" alt="image-20250704222414649"></p>
<p>联机成功。</p>
<p><img src="/undefined/f18ea7eb/image-20250704222825472.png" alt="image-20250704222825472"></p>
<p>目前我们实现了最基础的局域网联机。使用 UE 提供的 <code>ServerTravel</code> 和 <code>ClientTravel</code> 方法，我们可以让一台设备以 listen server 的身份运行，并允许其他局域网内的设备通过 IP 地址连接进来。虽然方式简单直接，但依赖于网络环境，难以在公网环境中稳定使用。为了解决这一问题，我们将在下一节引入 UE 的 <code>OnlineSubsystem</code>模块，并通过 Steam 实现跨网段联机。</p>
<h2 id="2-测试通过Steam进行联机"><a href="#2-测试通过Steam进行联机" class="headerlink" title="2 测试通过Steam进行联机"></a>2 测试通过Steam进行联机</h2><p><strong>在线子系统（Online Subsystem）</strong> 及其接口提供一种可访问<code>Steam</code>、<code>Xbox Live</code>、<code>Facebook</code>等在线服务功能的常用方法。开发一款在多平台上发行或支持多在线服务的游戏时，在线子系统可确保开发者唯一需要做的变更就是对所有支持的服务进行配置调整。UE引擎提供了一系列针对不同平台的Online Subsystem插件，而本项目中使用的就是针对Steam平台的插件，它提供了底层 <code>SteamNetDriver</code>、<code>SteamSession</code>、<code>SteamAPI</code>调用封装等模块。</p>
<p><a target="_blank" rel="noopener" href="https://dev.epicgames.com/documentation/zh-cn/unreal-engine/online-subsystem-in-unreal-engine?application_version=5.5">Online Subsystem in Unreal Engine | 虚幻引擎 5.5 文档 | Epic Developer Community</a></p>
<p><a target="_blank" rel="noopener" href="https://dev.epicgames.com/documentation/zh-cn/unreal-engine/online-subsystem-steam-interface-in-unreal-engine?application_version=5.5">虚幻引擎Steam在线子系统接口 | 虚幻引擎 5.5 文档 | Epic Developer Community</a></p>
<p>详细的使用方法可以参照官方文档。</p>
<h3 id="2-1-配置"><a href="#2-1-配置" class="headerlink" title="2.1 配置"></a>2.1 配置</h3><p>创建新的项目后，我们需要开启这个插件：</p>
<p><img src="/undefined/f18ea7eb/image-20250704223838193.png" alt="image-20250704223838193"></p>
<p>并且在配置文件(Config/DefaultEngine.INI)中添加以下内容：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[/Script/Engine.GameEngine]</span></span><br><span class="line">+<span class="attr">NetDriverDefinitions</span>=(DefName=<span class="string">&quot;GameNetDriver&quot;</span>,DriverClassName=<span class="string">&quot;OnlineSubsystemSteam.SteamNetDriver&quot;</span>,DriverClassNameFallback=<span class="string">&quot;OnlineSubsystemUtils.IpNetDriver&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="section">[OnlineSubsystem]</span></span><br><span class="line"><span class="attr">DefaultPlatformService</span>=Steam</span><br><span class="line"></span><br><span class="line"><span class="section">[OnlineSubsystemSteam]</span></span><br><span class="line"><span class="attr">bEnabled</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">SteamDevAppId</span>=<span class="number">480</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; If using Sessions</span></span><br><span class="line"><span class="comment">; bInitServerOnClient=true</span></span><br><span class="line"></span><br><span class="line"><span class="section">[/Script/OnlineSubsystemSteam.SteamNetDriver]</span></span><br><span class="line"><span class="attr">NetConnectionClassName</span>=<span class="string">&quot;OnlineSubsystemSteam.SteamNetConnection&quot;</span></span><br></pre></td></tr></table></figure>
<p>这么做是为了告诉 UE：”默认的联机服务平台是 Steam。“<code>SteamDevAppId=480</code> 是 Valve 提供的<strong>开发专用测试 ID（SpaceWar）</strong>，允许不通过 Steam 发布就进行测试联机。<code>bEnabled=true</code> 是显式启用插件。</p>
<p>我们还需要手动在构建文件<code>MenuSystem.Build.cs</code>中添加模块依赖：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MenuSystem</span> : ModuleRules</span><br><span class="line">&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MenuSystem</span><span class="params">(ReadOnlyTargetRules Target)</span> : base(Target)</span></span><br><span class="line"><span class="function">	&#123;</span></span><br><span class="line">		PCHUsage = PCHUsageMode.UseExplicitOrSharedPCHs;</span><br><span class="line"></span><br><span class="line">		PublicDependencyModuleNames.<span class="built_in">AddRange</span>(<span class="keyword">new</span> string[] &#123; ...（原有模块）, <span class="string">&quot;OnlineSubsystemSteam&quot;</span>, <span class="string">&quot;OnlineSubsystem&quot;</span> &#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>UE 构建系统依赖这些模块标记来将插件静态链接进你的项目。OSS 是跨模块插件，不声明无法访问接口。</p>
<p>最后重新构建项目，就完成了配置。</p>
<h3 id="2-2-获取会话接口"><a href="#2-2-获取会话接口" class="headerlink" title="2.2 获取会话接口"></a>2.2 获取会话接口</h3><p>因为现在要做的是测试Steam的联机功能，所以就不新建一个类了，而是直接在角色类中实现。</p>
<p>要通过在线子系统实现联机，我们首先要做的就是<strong>访问在线子系统并获取Session接口</strong>。这是后续实现 <strong>创建/查找/加入会话</strong>（Session）功能的基础。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MenuSystemCharacter.h</span></span><br><span class="line">IOnlineSessionPtr OnlineSessionInterface; </span><br><span class="line"></span><br><span class="line"><span class="comment">//MenuSystemCharacter.cpp</span></span><br><span class="line">AMenuSystemCharacter::<span class="built_in">AMenuSystemCharacter</span>() :</span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// 构造函数的其它逻辑</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	IOnlineSubsystem* OnlineSubsystem = IOnlineSubsystem::<span class="built_in">Get</span>();</span><br><span class="line">	<span class="keyword">if</span> (OnlineSubsystem) &#123;</span><br><span class="line">		OnlineSessionInterface = OnlineSubsystem-&gt;<span class="built_in">GetSessionInterface</span>();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (GEngine) &#123;</span><br><span class="line">			GEngine-&gt;<span class="built_in">AddOnScreenDebugMessage</span>(</span><br><span class="line">				<span class="number">-1</span>,</span><br><span class="line">				<span class="number">15.f</span>,</span><br><span class="line">				FColor::Blue,</span><br><span class="line">				FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Found subsystem %s&quot;</span>), *OnlineSubsystem-&gt;<span class="built_in">GetSubsystemName</span>().<span class="built_in">ToString</span>())</span><br><span class="line">			);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们首先声明了一个<code>IOnlineSessionPtr</code>成员变量，这个变量本质上是一个<code>IOnlineSessiion</code>类的共享指针，并保证了线程安全。在构造函数中，我们通过<code>IOnlineSubsystem::Get()</code>方法获取到了当前激活的在线子系统。这里的 <code>Get()</code> 是一个 <strong>静态方法</strong>，它是通过名称条件，查找已经进行注册/创建的实例。<strong>各个平台注册自己的子系统，然后让用户通过 <code>Get()</code> 全局访问。</strong></p>
<p>获取成功后，我们就可以通过在线子系统为<code>OnlineSessionInterface</code>进行赋值，从而获得了会话模块的接口（下文简称<strong>会话接口</strong>）。通过会话接口，我们就可以进行接下来的创建、查找、加入会话等工作。</p>
<p>获得接口后，我们可以将其名称打印在屏幕上，来观察是否成功获取了Steam子系统。</p>
<p>注意，这里要打包项目后运行打包好的项目才能观察到正确的结果。因为编辑器里不会启用 Steam OSS，打包后才会真正加载 Steam 子系统。</p>
<p><img src="/undefined/f18ea7eb/image-20250704230838975.png" alt="image-20250704230838975"></p>
<h3 id="2-3-创建会话"><a href="#2-3-创建会话" class="headerlink" title="2.3 创建会话"></a>2.3 创建会话</h3><p>获得了会话接口后，就可以用其提供的各种方法进行对话的创建、寻找、加入、销毁等操作，从而实现联机。首先从创建会话开始。</p>
<p>创建会话的流程包含三个步骤：</p>
<ul>
<li><p>绑定创建会话委托（用于接收异步回调）</p>
</li>
<li><p>构造会话设置对象（设置连接数、匹配类型等）</p>
</li>
<li><p>调用在线子系统接口创建会话（异步操作）</p>
</li>
</ul>
<p>我声明了一个创建会话的接口函数和一个<strong>回调函数</strong>，以及一个<strong>委托</strong>。简单来说，委托可以绑定一个（或多个，根据委托的类型来决定）回调函数，我们可以对委托进行（手动或自动）广播，这样所有和这个委托绑定的回调函数都会被调用。委托是实现异步通信的一个常用方法。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="built_in">UFUNCTION</span>(BlueprintCallable)</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">CreateGameSession</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* Delegate fired when a session create request has completed</span></span><br><span class="line"><span class="comment">	*</span></span><br><span class="line"><span class="comment">	* @param SessionName the name of the session this callback is for</span></span><br><span class="line"><span class="comment">	* @param bWasSuccessful true if the async action completed without error, false if there was an error</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">OnCreateSessionComplete</span><span class="params">(FName SessionName, <span class="type">bool</span> bWasSuccessful)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	FOnCreateSessionCompleteDelegate CreateSessionCompleteDelegate;</span><br></pre></td></tr></table></figure>
<p>UE 的 OSS 就是一个<strong>异步系统</strong>，创建 Session 不会立刻完成，必须用回调函数处理结果。<code>FOnCreateSessionCompleteDelegate</code> 是一个专门用于监听创建结果的事件类型。</p>
<p>我们可以直接在构造函数的初始化列表中将委托与回调函数进行绑定：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CreateSessionCompleteDelegate</span>(FOnCreateSessionCompleteDelegate::<span class="built_in">CreateUObject</span>(<span class="keyword">this</span>, &amp;ThisClass::OnCreateSessionComplete))</span><br></pre></td></tr></table></figure>
<p>接下来就是创建会话了。在<code>CreateGameSession</code>函数实现以下逻辑：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">AMenuSystemCharacter::CreateGameSession</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//按“1”调用函数</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">//检查指针是否有效</span></span><br><span class="line">	<span class="keyword">if</span> (!OnlineSessionInterface.<span class="built_in">IsValid</span>()) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//检查当前是否存在会话，如果有，将其销毁</span></span><br><span class="line">	<span class="keyword">auto</span> ExistingSession = OnlineSessionInterface-&gt;<span class="built_in">GetNamedSession</span>(NAME_GameSession);</span><br><span class="line">	<span class="keyword">if</span> (ExistingSession) &#123;</span><br><span class="line">		OnlineSessionInterface-&gt;<span class="built_in">DestroySession</span>(NAME_GameSession);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//将委托添加到列表，进行会话设置，创建会话</span></span><br><span class="line">	OnlineSessionInterface-&gt;<span class="built_in">AddOnCreateSessionCompleteDelegate_Handle</span>(CreateSessionCompleteDelegate);</span><br><span class="line"></span><br><span class="line">	TSharedPtr&lt;FOnlineSessionSettings&gt; SessionSettings = <span class="built_in">MakeShareable</span>(<span class="keyword">new</span> <span class="built_in">FOnlineSessionSettings</span>());</span><br><span class="line">	SessionSettings-&gt;bIsLANMatch = <span class="literal">false</span>; <span class="comment">//是否为局域网匹配</span></span><br><span class="line">	SessionSettings-&gt;NumPublicConnections = <span class="number">4</span>; <span class="comment">//最大联机数量</span></span><br><span class="line">	SessionSettings-&gt;bAllowJoinInProgress = <span class="literal">true</span>; <span class="comment">//是否允许中途加入</span></span><br><span class="line">	SessionSettings-&gt;bAllowJoinViaPresence = <span class="literal">true</span>; <span class="comment">//是否允许通过 Steam 好友加入</span></span><br><span class="line">	SessionSettings-&gt;bShouldAdvertise = <span class="literal">true</span>; <span class="comment">//是否将房间暴露出去</span></span><br><span class="line">	SessionSettings-&gt;bUsesPresence = <span class="literal">true</span>; <span class="comment">//是否使用“在线状态系统”</span></span><br><span class="line">	SessionSettings-&gt;bUseLobbiesIfAvailable = <span class="literal">true</span>; <span class="comment">//是否使用 Steam Lobby 功能</span></span><br><span class="line">	SessionSettings-&gt;<span class="built_in">Set</span>(<span class="built_in">FName</span>(<span class="string">&quot;MatchType&quot;</span>), <span class="built_in">FString</span>(<span class="string">&quot;FreeForAll&quot;</span>), EOnlineDataAdvertisementType::ViaOnlineServiceAndPing);</span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> ULocalPlayer* localPlayer = <span class="built_in">GetWorld</span>()-&gt;<span class="built_in">GetFirstLocalPlayerFromController</span>();</span><br><span class="line">	OnlineSessionInterface-&gt;<span class="built_in">CreateSession</span>(*localPlayer-&gt;<span class="built_in">GetPreferredUniqueNetId</span>(), NAME_GameSession, *SessionSettings);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果当前已经存在会话，我们需要将其销毁。然后将我们声明的委托添加到列表中。这是OSS提供的方法，当使用OSS的接口创建会话后，它就会对列表中的所有委托进行广播，进而调用与委托绑定的函数。下面通过共享指针定义了一个会话设置，里面定义了一些要创建的会话的信息。在我使用的版本(UE5.5)需要设置<code>bUseLobbiesIfAvailable = true</code>才能进行正常联机。最后就是创建会话了。UE 的 Session 创建需要提供唯一身份 ID，<code>localPlayer-&gt;GetPreferredUniqueNetId()</code> 就是当前 Steam 登录用户的标识，需要通过获得当前的玩家去获得身份ID。</p>
<blockquote>
<p>为什么在创建会话设置的对象时，要在堆上创建并使用共享指针进行管理，而不是创建一个临时变量？</p>
<p><code>Unreal</code>的会话接口（如 <code>CreateSession</code>）是<strong>异步操作</strong>，也就是说函数返回后，实际的会话创建过程仍在后台执行，直到系统触发对应的回调函数。如果我们使用的是函数内的局部变量，那么在函数结束时，该对象会自动析构。而此时后台异步操作还未完成，它若尝试访问这个已销毁的对象，就会产生<strong>未定义行为</strong>，导致程序崩溃。如果改为值传递，虽然避免了悬空指针的问题，但这会引入一次<strong>不必要的深拷贝开销</strong>。因此，更推荐的做法是使用 <code>TSharedPtr</code>，通过 <code>MakeShareable(new ...)</code> 将 <code>SessionSettings</code> 分配到堆上，主动管理生命周期，即使函数返回，内部的引用计数仍保持为 1（或以上），直到异步流程完成后系统再销毁该对象。这样既避免了复制，也保证了稳定性。</p>
<p>之后有很多功能都会用到这个操作，思想大概都是这样。</p>
</blockquote>
<p>回调函数的逻辑很简单，当创建会话完成后触发<code>CreateSessionCompleteDelegate</code>委托的广播，自动调用创建会话的回调函数。如果传入的值为<code>true</code>，说明创建成功，传送到大厅并设为监听服务器。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">AMenuSystemCharacter::OnCreateSessionComplete</span><span class="params">(FName SessionName, <span class="type">bool</span> bWasSussful)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (bWasSussful) &#123;</span><br><span class="line">		<span class="keyword">if</span> (GEngine) &#123;</span><br><span class="line">			GEngine-&gt;<span class="built_in">AddOnScreenDebugMessage</span>(</span><br><span class="line">				<span class="number">-1</span>,</span><br><span class="line">				<span class="number">15.f</span>,</span><br><span class="line">				FColor::Blue,</span><br><span class="line">				FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Created session: %s&quot;</span>),*SessionName.<span class="built_in">ToString</span>())</span><br><span class="line">			);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		UWorld* world = <span class="built_in">GetWorld</span>();</span><br><span class="line">		<span class="keyword">if</span> (world) &#123;</span><br><span class="line">			world-&gt;<span class="built_in">ServerTravel</span>(<span class="built_in">FString</span>(<span class="string">&quot;/Game/ThirdPerson/Maps/Lobby?listen&quot;</span>)); <span class="comment">//打开大厅地图并设为服务器</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (GEngine) &#123;</span><br><span class="line">			GEngine-&gt;<span class="built_in">AddOnScreenDebugMessage</span>(</span><br><span class="line">				<span class="number">-1</span>,</span><br><span class="line">				<span class="number">15.f</span>,</span><br><span class="line">				FColor::Red,</span><br><span class="line">				<span class="built_in">FString</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Failed to create session!&quot;</span>))</span><br><span class="line">			);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-4-加入会话"><a href="#2-4-加入会话" class="headerlink" title="2.4 加入会话"></a>2.4 加入会话</h3><p>实现创建会话后，顺理成章的就要开始实现加入会话了。和创建会话时相同，声明加入会话的函数和两个回调函数，以及两个相应的委托，分别用于发现会话和加入会话，并将委托和回调函数进行绑定。还声明了一个成员变量，用来存储搜索的条件和结果等（存疑）。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">//MenuSystemCharacter.h</span><br><span class="line">	UFUNCTION(BlueprintCallable)</span><br><span class="line">	void JoinGameSession();</span><br><span class="line">	</span><br><span class="line">	void OnFindSessionsComplete(bool bWasSuccessful);</span><br><span class="line">	void OnJoinSessionComplete(FName SessionName, EOnJoinSessionCompleteResult::Type Result);</span><br><span class="line">	</span><br><span class="line">	FOnFindSessionsCompleteDelegate FindSessionsCompleteDelegate;</span><br><span class="line">	FOnJoinSessionCompleteDelegate JoinSessionCompleteDelegate;</span><br><span class="line">	TSharedPtr&lt;FOnlineSessionSearch&gt; SessionSearch;</span><br><span class="line">	</span><br><span class="line">//MenuSystemCharacter.cpp</span><br><span class="line">	//构造函数的初始化列表</span><br><span class="line">	FindSessionsCompleteDelegate(FOnFindSessionsCompleteDelegate::CreateUObject(this, &amp;ThisClass::OnFindSessionsComplete)),</span><br><span class="line">	JoinSessionCompleteDelegate(FOnJoinSessionCompleteDelegate::CreateUObject(this, &amp;ThisClass::OnJoinSessionComplete))</span><br></pre></td></tr></table></figure>
<p>将发现会话的委托添加到委托列表，创建一个寻找会话的条件，就可以开始寻找会话了。之后使用本地玩家的<code>NetID</code>向 OSS 发起搜索请求。<strong>此过程也是异步的</strong>。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">AMenuSystemCharacter::JoinGameSession</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!OnlineSessionInterface.<span class="built_in">IsValid</span>()) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	OnlineSessionInterface-&gt;<span class="built_in">AddOnFindSessionsCompleteDelegate_Handle</span>(FindSessionsCompleteDelegate);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//寻找会话</span></span><br><span class="line">	SessionSearch = <span class="built_in">MakeShareable</span>(<span class="keyword">new</span> <span class="built_in">FOnlineSessionSearch</span>());</span><br><span class="line">	SessionSearch-&gt;MaxSearchResults = <span class="number">10000</span>; <span class="comment">//最多查找多少个房间</span></span><br><span class="line">	SessionSearch-&gt;bIsLanQuery = <span class="literal">false</span>; <span class="comment">//是否为局域网查找</span></span><br><span class="line">	SessionSearch-&gt;QuerySettings.<span class="built_in">Set</span>(SEARCH_PRESENCE, <span class="literal">true</span>, EOnlineComparisonOp::Equals); <span class="comment">//查找支持好友加入/展示的房间</span></span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> ULocalPlayer* LocalPlayer = <span class="built_in">GetWorld</span>()-&gt;<span class="built_in">GetFirstLocalPlayerFromController</span>();</span><br><span class="line">	OnlineSessionInterface-&gt;<span class="built_in">FindSessions</span>(*LocalPlayer-&gt;<span class="built_in">GetPreferredUniqueNetId</span>(), SessionSearch.<span class="built_in">ToSharedRef</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>寻找会话完成后，会调用寻找会话委托绑定的回调函数。在回调函数中，我们需要对寻找到的结果进行一些筛选。当找到符合要求的会话后，就需要加入这个会话了。将加入会话的委托加入委托列表，就可以通过NetID加入会话了。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">AMenuSystemCharacter::OnFindSessionsComplete</span><span class="params">(<span class="type">bool</span> bWasSuccessful)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!OnlineSessionInterface.<span class="built_in">IsValid</span>()) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">auto</span> result : SessionSearch-&gt;SearchResults) &#123;</span><br><span class="line">		FString Id = result.<span class="built_in">GetSessionIdStr</span>(); <span class="comment">//获得会话ID</span></span><br><span class="line">		FString User = result.Session.OwningUserName; <span class="comment">//获得会话拥有者</span></span><br><span class="line">		FString MatchType;</span><br><span class="line">		result.Session.SessionSettings.<span class="built_in">Get</span>(<span class="built_in">FName</span>(<span class="string">&quot;MatchType&quot;</span>), MatchType); <span class="comment">//获取比赛类型</span></span><br><span class="line">		<span class="keyword">if</span>(GEngine) &#123;</span><br><span class="line">			GEngine-&gt;<span class="built_in">AddOnScreenDebugMessage</span>(</span><br><span class="line">				<span class="number">-1</span>,</span><br><span class="line">				<span class="number">15.f</span>,</span><br><span class="line">				FColor::Cyan,</span><br><span class="line">				FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Id: %s, User: %s&quot;</span>), *Id, *User)</span><br><span class="line">			);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//检查比赛类型是否是FreeForAll</span></span><br><span class="line">		<span class="keyword">if</span> (MatchType == <span class="built_in">FString</span>(<span class="string">&quot;FreeForAll&quot;</span>)) &#123;</span><br><span class="line">			<span class="keyword">if</span> (GEngine) &#123;</span><br><span class="line">				GEngine-&gt;<span class="built_in">AddOnScreenDebugMessage</span>(</span><br><span class="line">					<span class="number">-1</span>,</span><br><span class="line">					<span class="number">15.f</span>,</span><br><span class="line">					FColor::Cyan,</span><br><span class="line">					FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Joing Match Type: %s&quot;</span>), *MatchType)</span><br><span class="line">				);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			OnlineSessionInterface-&gt;<span class="built_in">AddOnJoinSessionCompleteDelegate_Handle</span>(JoinSessionCompleteDelegate);</span><br><span class="line"></span><br><span class="line">			<span class="type">const</span> ULocalPlayer* localPlayer = <span class="built_in">GetWorld</span>()-&gt;<span class="built_in">GetFirstLocalPlayerFromController</span>();</span><br><span class="line">			OnlineSessionInterface-&gt;<span class="built_in">JoinSession</span>(*localPlayer-&gt;<span class="built_in">GetPreferredUniqueNetId</span>(), NAME_GameSession, Result);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>加入会话后，会调用加入会话的回调函数。因为加入会话并不会将客户端自动传送至主机地图，在这里要使用<code>ClientTravel</code>方法将玩家传送到主机所在的地图。其中的地址是通过会话接口解析会话得到的。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">AMenuSystemCharacter::OnJoinSessionComplete</span><span class="params">(FName SessionName, EOnJoinSessionCompleteResult::Type Result)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!OnlineSessionInterface.<span class="built_in">IsValid</span>()) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	FString Address;</span><br><span class="line">	<span class="keyword">if</span> (OnlineSessionInterface-&gt;<span class="built_in">GetResolvedConnectString</span>(NAME_GameSession, Address)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (GEngine) &#123;</span><br><span class="line">			GEngine-&gt;<span class="built_in">AddOnScreenDebugMessage</span>(</span><br><span class="line">				<span class="number">-1</span>,</span><br><span class="line">				<span class="number">15.f</span>,</span><br><span class="line">				FColor::Yellow,</span><br><span class="line">				FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Connext string: %s&quot;</span>), *Address)</span><br><span class="line">			);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		APlayerController* PlayerController = <span class="built_in">GetGameInstance</span>()-&gt;<span class="built_in">GetFirstLocalPlayerController</span>();</span><br><span class="line">		<span class="keyword">if</span> (PlayerController) &#123;</span><br><span class="line">			PlayerController-&gt;<span class="built_in">ClientTravel</span>(Address, ETravelType::TRAVEL_Absolute);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		GEngine-&gt;<span class="built_in">AddOnScreenDebugMessage</span>(</span><br><span class="line">			<span class="number">-1</span>,</span><br><span class="line">			<span class="number">15.f</span>,</span><br><span class="line">			FColor::Yellow,</span><br><span class="line">			FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Address Not Find&quot;</span>))</span><br><span class="line">		);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一个简单的联机逻辑就这样实现了。里面有很多逻辑不够严密的地方，并且选项都是写死的，但是用作测试已经足够了。</p>
<p>在进行测试时，需要两台电脑，分别登录两个不同的Steam账号，并且下载地点设为同一个地方。启动游戏，一遍按<code>1</code>调用创建会话，另一边按<code>2</code>加入会话。成功！</p>
<h2 id="3-插件制作"><a href="#3-插件制作" class="headerlink" title="3.插件制作"></a>3.插件制作</h2><p>终于到了这篇文章的重点。我想制作一个插件，使得无论何时我想制作一个多人联机项目，只要安装制作好的插件就可以通过调用它的一些接口，轻松实现联机功能。</p>
<h3 id="3-1-配置"><a href="#3-1-配置" class="headerlink" title="3.1 配置"></a>3.1 配置</h3><p>创建一个空白插件。</p>
<p><img src="/undefined/f18ea7eb/image-20250706224649885.png" alt="image-20250706224649885"></p>
<p>我们需要声明这个插件需要依赖的插件。本插件依赖于官方插件<code>OnlineSubsystem</code>和<code>OnlineSubsystemSteam</code>，因此需要在插件的<code>.uplugin</code>文件中加上下面的内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&quot;Plugins&quot;: [</span><br><span class="line">	&#123;</span><br><span class="line">		&quot;Name&quot;: &quot;OnlineSubsystem&quot;,</span><br><span class="line">		&quot;Enabled&quot;: true</span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		&quot;Name&quot;: &quot;OnlineSubsystemSteam&quot;,</span><br><span class="line">		&quot;Enabled&quot;: true</span><br><span class="line">	&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>它告诉 UE 编译器 <strong>在启用本插件时自动启用这两个插件</strong>，避免了手动逐一勾选的麻烦。</p>
<p>并且在插件的构建文件中加上：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PublicDependencyModuleNames.AddRange(</span><br><span class="line">	<span class="keyword">new</span> <span class="built_in">string</span>[]</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="string">&quot;Core&quot;</span>,</span><br><span class="line">		<span class="string">&quot;OnlineSubsystem&quot;</span>,</span><br><span class="line">		<span class="string">&quot;OnlineSubsystemSteam&quot;</span></span><br><span class="line">		<span class="comment">// ... add other public dependencies that you statically link with here ...</span></span><br><span class="line">	&#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>这是告诉 <code>Unreal Build Tool（UBT）</code>：<strong>本插件在编译时需要链接 <code>OnlineSubsystem</code> 和 Steam 的 C++ 模块</strong>，否则在代码中引用 <code>IOnlineSession</code>、<code>FOnlineSessionSettings</code> 等类会编译失败。</p>
<h3 id="3-2-创建自己的类"><a href="#3-2-创建自己的类" class="headerlink" title="3.2 创建自己的类"></a>3.2 创建自己的类</h3><p><strong>这里我画了一个图，用于方便看懂插件中的四大部分之间是如何交互的</strong>。之后的所有内容都遵循这个流程，因为具体功能实现方式和上面其实差不多，所以只做简单讲解。</p>
<p><img src="/undefined/f18ea7eb/image-20250709232702573.png" alt="image-20250709232702573"></p>
<p>插件的实现主要依靠实现一个自己的类：<code>MultiplayerSessionsSubsystem</code>类，它继承自<strong>游戏实例子系统类</strong>(<code>UGameInstanceSubsystem</code>)。<code>UGameInstanceSubsystem</code> 是 Unreal Engine 提供的一种<strong>全局生命周期子系统</strong>，它在游戏启动后就存在，并<strong>贯穿整个游戏生命周期，不会因为关卡切换而销毁</strong>。<code>MultiplayerSessionsSubsystem</code>类是插件的核心，主要提供了一些对于会话的操作的接口以及相应操作的委托，只要使用这些接口和委托就可以快速实现联机。</p>
<p>首先需要获取在线会话接口并进行初始化：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MultiplayerSessionsSubsystem.h</span></span><br><span class="line">OnlineSessionPtr SessionInterface;</span><br><span class="line"></span><br><span class="line"><span class="comment">//MultiplayerSessionsSubsystem.cpp</span></span><br><span class="line">IOnlineSubsystem* Subsystem = IOnlineSubsystem::<span class="built_in">Get</span>();</span><br><span class="line"><span class="keyword">if</span> (Subsystem) &#123;</span><br><span class="line">	SessionInterface = Subsystem-&gt;<span class="built_in">GetSessionInterface</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们的类中将会提供创建、寻找、加入、销毁、开始会话的五个接口，而这些接口实现其功能的方式则主要依赖于这个在线会话接口。现在来声明这些接口，并声明这些功能对应的委托及回调函数。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">UMultiplayerSessionsSubsystem</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// 外部接口：供 UI 或其他模块调用的多人联机会话控制函数</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">CreateSession</span><span class="params">(int32 NumPublicConnections, FString MatchType)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">FindSessions</span><span class="params">(<span class="type">int</span> MaxSearchResults)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">JoinSessions</span><span class="params">(<span class="type">const</span> FOnlineSessionSearchResult&amp; SessionResult)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">DestroySession</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">StartSession</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// 回调函数：会被 OnlineSubsystem 在异步操作完成后自动调用</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">OnCreateSessionComplete</span><span class="params">(FName SessionName, <span class="type">bool</span> bWasSuccessful)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">OnFindSessionsComplete</span><span class="params">(<span class="type">bool</span> bWasSuccessful)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">OnJoinSessionComplete</span><span class="params">(FName SessionName, EOnJoinSessionCompleteResult::Type Result)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">OnDestroySessionComplete</span><span class="params">(FName SessionName, <span class="type">bool</span> bWasSuccessful)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">OnStartSessionComplete</span><span class="params">(FName SessionName, <span class="type">bool</span> bWasSuccessful)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	IOnlineSessionPtr SessionInterface;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// 委托声明+绑定：将回调函数挂载到OnlineSubsystem的事件通知中</span></span><br><span class="line">	<span class="comment">// 每个委托都有对应的DelegateHandle用于解绑（防止重复绑定）</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	FOnCreateSessionCompleteDelegate CreateSessionCompleteDelegate;</span><br><span class="line">	FDelegateHandle CreateSessionCompleteDelegateHandle;</span><br><span class="line">	FOnFindSessionsCompleteDelegate FindSessionsCompleteDelegate;</span><br><span class="line">	FDelegateHandle FindSessionsCompleteDelegateHandle;</span><br><span class="line">	FOnJoinSessionCompleteDelegate JoinSessionCompleteDelegate;</span><br><span class="line">	FDelegateHandle JoinSessionCompleteDelegateHandle;</span><br><span class="line">	FOnDestroySessionCompleteDelegate DestroySessionCompleteDelegate;</span><br><span class="line">	FDelegateHandle DestroySessionCompleteDelegateHandle;</span><br><span class="line">	FOnStartSessionCompleteDelegate StartSessionCompleteDelegate;</span><br><span class="line">	FDelegateHandle StartSessionCompleteDelegateHandle;</span><br></pre></td></tr></table></figure>
<p>将委托和回调函数进行绑定：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CreateSessionCompleteDelegate</span>(FOnCreateSessionCompleteDelegate::<span class="built_in">CreateUObject</span>(<span class="keyword">this</span>,&amp;ThisClass::OnCreateSessionComplete)),</span><br><span class="line"><span class="built_in">FindSessionsCompleteDelegate</span>(FOnFindSessionsCompleteDelegate::<span class="built_in">CreateUObject</span>(<span class="keyword">this</span>, &amp;ThisClass::OnFindSessionsComplete)),</span><br><span class="line"><span class="built_in">JoinSessionCompleteDelegate</span>(FOnJoinSessionCompleteDelegate::<span class="built_in">CreateUObject</span>(<span class="keyword">this</span>, &amp;ThisClass::OnJoinSessionComplete)),</span><br><span class="line"><span class="built_in">DestroySessionCompleteDelegate</span>(FOnDestroySessionCompleteDelegate::<span class="built_in">CreateUObject</span>(<span class="keyword">this</span>, &amp;ThisClass::OnDestroySessionComplete)),</span><br><span class="line"><span class="built_in">StartSessionCompleteDelegate</span>(FOnStartSessionCompleteDelegate::<span class="built_in">CreateUObject</span>(<span class="keyword">this</span>, &amp;ThisClass::OnStartSessionComplete))</span><br></pre></td></tr></table></figure>
<p>这里在声明委托的同时也声明了其对应的<strong>句柄</strong>，这是为了在需要时能“解绑”委托回调函数，避免重复绑定或内存泄漏。当我们将委托添加到对应的委托列表后，它是不会自动移除的。<strong>如果重复多次进行这一操作，同一个函数会被绑定多次，将会在回调时被多次调用</strong>（重复执行）。因此，为了后续解绑，需要保留绑定操作返回的<strong>句柄 <code>FDelegateHandle</code></strong>。</p>
<p>我们还将创建一个菜单类，这个类继承自<code>UserWidget</code>类，会通过调用<code>MultiplayerSessionsSubsystem</code>类的接口将对会话的操作简化成最简单的两个步骤：按下<code>Host</code>按钮和按下<code>Join</code>按钮。这样一来，使用插件时既可以在安装插件后直接使用最简单的联机功能，也可以通过提供的接口实现更多功能。</p>
<p>菜单类的构建文件中需要添加以下内容：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;UMG&quot;</span>,</span><br><span class="line"><span class="string">&quot;Slate&quot;</span>,</span><br><span class="line"><span class="string">&quot;SlateCore&quot;</span></span><br></pre></td></tr></table></figure>
<p>在菜单类中，先定义一个初始化菜单的函数，将菜单添加到视图上，并将输入模式设为仅UI，将光标显示出来。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">UMenu::MenuSetup</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">AddToViewport</span>();</span><br><span class="line">	<span class="built_in">SetVisibility</span>(ESlateVisibility::Visible);</span><br><span class="line">	<span class="comment">//SetFocus();</span></span><br><span class="line">	bIsFocusable = <span class="literal">true</span>; <span class="comment">//按理说这一步在新版本的UE中被弃用了，应该被替换成上面的SetFocus函数，并且我最开始也是这么做的，但是后面莫名其妙又可以用这个方法了，并且还是有效的</span></span><br><span class="line"></span><br><span class="line">	UWorld* World = <span class="built_in">GetWorld</span>();</span><br><span class="line">	<span class="keyword">if</span> (World) &#123;</span><br><span class="line">		APlayerController* PlayerController = World-&gt;<span class="built_in">GetFirstPlayerController</span>();</span><br><span class="line">		<span class="keyword">if</span> (PlayerController) &#123;</span><br><span class="line">			FInputModeUIOnly InputModeData;</span><br><span class="line">			InputModeData.<span class="built_in">SetWidgetToFocus</span>(<span class="built_in">TakeWidget</span>());</span><br><span class="line">			InputModeData.<span class="built_in">SetLockMouseToViewportBehavior</span>(EMouseLockMode::DoNotLock);</span><br><span class="line">			PlayerController-&gt;<span class="built_in">SetInputMode</span>(InputModeData);</span><br><span class="line">			PlayerController-&gt;<span class="built_in">SetShowMouseCursor</span>(<span class="literal">true</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>菜单的创建属于基础内容，直接快进。</p>
<p><img src="/undefined/f18ea7eb/image-20250707220712885.png" alt="image-20250707220712885"></p>
<p>在菜单类中对这两个按钮进行绑定，方法是使用元数据<code>meta=(BindWidget)</code>。声明这两个按钮的回调函数，并声明一个多人会话子系统的指针。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UPROPERTY</span>(meta = (BindWidget))</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UButton</span>* HostButton;</span><br><span class="line"></span><br><span class="line"><span class="built_in">UPROPERTY</span>(meta = (BindWidget))</span><br><span class="line">UButton* JoinButton;</span><br><span class="line"></span><br><span class="line"><span class="built_in">UFUNCTION</span>()</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">HostButtonClicked</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">UFUNCTION</span>()</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">JoinButtonClicked</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理所有在线会话功能的子系统</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UMultiplayerSessionsSubsystem</span>* MultiplayerSessionsSubsystem;</span><br></pre></td></tr></table></figure>
<p>在<code>MenuSetup</code>函数中初始化子系统，并在UI初始化时将按钮点击的委托和回调函数进行绑定。注意，<strong>绑定的逻辑要放在<code>Initialize</code>函数中，而不是构造函数中，因为在构造函数调用时还无法访问蓝图中的控件，而<code>Initialize</code>函数会在控件全部加载完成后调用</strong>。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MenuSetup函数</span></span><br><span class="line">UGameInstance* GameInstance = <span class="built_in">GetGameInstance</span>();</span><br><span class="line"><span class="keyword">if</span> (GameInstance) &#123;</span><br><span class="line">	MultiplayerSessionsSubsystem = GameInstance-&gt;<span class="built_in">GetSubsystem</span>&lt;UMultiplayerSessionsSubsystem&gt;();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">UMenu::Initialize</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!Super::<span class="built_in">Initialize</span>()) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (HostButton) &#123;</span><br><span class="line">		HostButton-&gt;OnClicked.<span class="built_in">AddDynamic</span>(<span class="keyword">this</span>, &amp;ThisClass::HostButtonClicked);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (JoinButton) &#123;</span><br><span class="line">		JoinButton-&gt;OnClicked.<span class="built_in">AddDynamic</span>(<span class="keyword">this</span>, &amp;ThisClass::JoinButtonClicked);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UMenu::HostButtonClicked</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (GEngine) &#123;</span><br><span class="line">		GEngine-&gt;<span class="built_in">AddOnScreenDebugMessage</span>(</span><br><span class="line">			<span class="number">-1</span>,</span><br><span class="line">			<span class="number">15.f</span>,</span><br><span class="line">			FColor::Yellow,</span><br><span class="line">			<span class="built_in">FString</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Host Button Clicked&quot;</span>))</span><br><span class="line">		);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (MultiplayerSessionsSubsystem) &#123;</span><br><span class="line">		MultiplayerSessionsSubsystem-&gt;<span class="built_in">CreateSession</span>(<span class="number">4</span>, <span class="built_in">FString</span>(<span class="string">&quot;FreeForAll&quot;</span>));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UMenu::JoinButtonClicked</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (GEngine) &#123;</span><br><span class="line">		GEngine-&gt;<span class="built_in">AddOnScreenDebugMessage</span>(</span><br><span class="line">			<span class="number">-1</span>,</span><br><span class="line">			<span class="number">15.f</span>,</span><br><span class="line">			FColor::Yellow,</span><br><span class="line">			<span class="built_in">FString</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Join Button Clicked&quot;</span>))</span><br><span class="line">		);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-3-创建会话"><a href="#3-3-创建会话" class="headerlink" title="3.3 创建会话"></a>3.3 创建会话</h3><p>回到<code>MultiplayerSessionsSubsystem</code>类，现在要实现创建会话的功能了。在创建会话的函数中，将创建会话的委托加入委托列表，并保存句柄方便后续的解绑。然后创建一个在线会话的设置，使用这个设置来通过接口创建会话。如果创建失败，需要将委托解绑。</p>
<p>在创建会话时，如果有已经存在的会话需要将其销毁，但是这个过程需要时间，如果在调用销毁函数后离开创建会话，很容易因为当前会话还未销毁完毕而创建失败。解决方法是创建了三个变量，表示当前有没有正在销毁的会话，以及要创建的会话的信息，然后在销毁会话完成后的回调函数中进行创建。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MultiplayerSessionsSubsystem.h</span></span><br><span class="line"><span class="type">bool</span> bCreateSessionOnDestroy = <span class="literal">false</span>;</span><br><span class="line">int32 LastNumPublicConnections;</span><br><span class="line">FString LastMatchType;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">UMultiplayerSessionsSubsystem::CreateSession</span><span class="params">(int32 NumPublicConnections, FString MatchType)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!SessionInterface.<span class="built_in">IsValid</span>()) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//如果有已经存在的会话，将其销毁</span></span><br><span class="line">	<span class="keyword">auto</span> ExistingSession = SessionInterface-&gt;<span class="built_in">GetNamedSession</span>(NAME_GameSession);</span><br><span class="line">	<span class="keyword">if</span> (ExistingSession) &#123;</span><br><span class="line">		bCreateSessionOnDestroy = <span class="literal">true</span>;</span><br><span class="line">		LastNumPublicConnections = NumPublicConnections;</span><br><span class="line">		LastMatchType = MatchType;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">DestroySession</span>();<span class="comment">//这个函数会在之后实现，创建会话在摧毁会话的回调函数中进行</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//将委托添加到列表，进行会话设置，创建会话。保存委托的句柄使我们之后可以从委托列表中将其移除。</span></span><br><span class="line">	CreateSessionCompleteDelegateHandle = SessionInterface-&gt;<span class="built_in">AddOnCreateSessionCompleteDelegate_Handle</span>(CreateSessionCompleteDelegate);</span><br><span class="line"></span><br><span class="line">	LastSessionSettings = <span class="built_in">MakeShareable</span>(<span class="keyword">new</span> <span class="built_in">FOnlineSessionSettings</span>());</span><br><span class="line">	LastSessionSettings-&gt;bIsLANMatch = IOnlineSubsystem::<span class="built_in">Get</span>()-&gt;<span class="built_in">GetSubsystemName</span>() == <span class="string">&quot;NULL&quot;</span>; <span class="comment">//是否为局域网匹配</span></span><br><span class="line">	LastSessionSettings-&gt;NumPublicConnections = NumPublicConnections; <span class="comment">//最大联机数量</span></span><br><span class="line">	LastSessionSettings-&gt;bAllowJoinInProgress = <span class="literal">true</span>; <span class="comment">//是否允许中途加入</span></span><br><span class="line">	LastSessionSettings-&gt;bAllowJoinViaPresence = <span class="literal">true</span>; <span class="comment">//是否允许通过 Steam 好友加入</span></span><br><span class="line">	LastSessionSettings-&gt;bShouldAdvertise = <span class="literal">true</span>; <span class="comment">//是否将房间暴露出去</span></span><br><span class="line">	LastSessionSettings-&gt;bUsesPresence = <span class="literal">true</span>; <span class="comment">//是否使用“在线状态系统”</span></span><br><span class="line">	LastSessionSettings-&gt;bUseLobbiesIfAvailable = <span class="literal">true</span>; <span class="comment">//是否使用 Steam Lobby 功能（新版UE需要启用这个功能才能创建会话）</span></span><br><span class="line">	LastSessionSettings-&gt;<span class="built_in">Set</span>(<span class="built_in">FName</span>(<span class="string">&quot;MatchType&quot;</span>), MatchType, EOnlineDataAdvertisementType::ViaOnlineServiceAndPing);</span><br><span class="line">	LastSessionSettings-&gt;BuildUniqueId = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> ULocalPlayer* LocalPlayer = <span class="built_in">GetWorld</span>()-&gt;<span class="built_in">GetFirstLocalPlayerFromController</span>();</span><br><span class="line">	<span class="keyword">if</span> (!SessionInterface-&gt;<span class="built_in">CreateSession</span>(*LocalPlayer-&gt;<span class="built_in">GetPreferredUniqueNetId</span>(), NAME_GameSession, *LastSessionSettings)) &#123;</span><br><span class="line">		SessionInterface-&gt;<span class="built_in">ClearOnCreateSessionCompleteDelegate_Handle</span>(CreateSessionCompleteDelegateHandle);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//广播我们的自定义委托</span></span><br><span class="line">		MultiplayerOnCreateSessionComplete.<span class="built_in">Broadcast</span>(<span class="literal">false</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在菜单类中声明三个变量，用来指定创建会话时的一些信息。在MenuSetup函数中接收这三个参数，为创建会话做好准备。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">MenuSetup</span><span class="params">(int32 NumberOfPublicConnections = <span class="number">4</span>, FString TypeOfMatch = FString(TEXT(<span class="string">&quot;FreeForAll&quot;</span>)), FString LobbyPath = FString(TEXT(<span class="string">&quot;/Game/ThirdPerson/Maps/Lobby&quot;</span>)))</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="comment">//最大连接数，匹配类型，大厅路径</span></span><br><span class="line">	int32 NumPublicConnections&#123; <span class="number">4</span> &#125;;</span><br><span class="line">	FString MatchType&#123; <span class="built_in">TEXT</span>(<span class="string">&quot;FreeForAll&quot;</span>) &#125;;</span><br><span class="line">	FString PathToLobby&#123; <span class="built_in">TEXT</span>(<span class="string">&quot;&quot;</span>) &#125;;</span><br></pre></td></tr></table></figure>
<p>按下<code>Host</code>按钮后，我们要做的就是调用<code>MultiplayerSessionsSubsystem</code>的<code>CreateSession</code>接口，将上面声明的变量传递过去用于创建会话。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (MultiplayerSessionsSubsystem) &#123;</span><br><span class="line">	MultiplayerSessionsSubsystem-&gt;<span class="built_in">CreateSession</span>(NumPublicConnections, MatchType);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>目前已经实现了<code>Menu</code>类对<code>MultiplayerSessionsSubsystem</code>类的单向通信（点击<code>Host</code>按钮后通过<code>MultiplayerSessionsSubsystem</code>类创建会话），但是还没有实现<code>MultiplayerSessionsSubsystem</code>类对<code>Menu</code>类的通信。这里实现双向通信的方式仍然是委托。我们在<code>MultiplayerSessionsSubsystem</code>类中声明一组委托，用于绑定<code>Menu</code>类的回调函数。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MultiplayerSessionsSubsystem.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 为菜单类声明我们自定义的委托，用于菜单类绑定</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="built_in">DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam</span>(FMultiplayerOnCreateSessionComplete, <span class="type">bool</span>, bWasSuccessful);</span><br><span class="line"><span class="built_in">DECLARE_MULTICAST_DELEGATE_TwoParams</span>(FMultiplayerOnFindSessionsComplete, <span class="type">const</span> TArray &lt;FOnlineSessionSearchResult&gt;&amp; SessionResults, <span class="type">bool</span> bWasSuccessful);</span><br><span class="line"><span class="built_in">DECLARE_MULTICAST_DELEGATE_OneParam</span>(FMultiplayerOnJoinSessionComplete, EOnJoinSessionCompleteResult::Type Result);</span><br><span class="line"><span class="built_in">DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam</span>(FMultiplayerOnDestroySessionComplete, <span class="type">bool</span>, bWasSuccessful);</span><br><span class="line"><span class="built_in">DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam</span>(FMultiplayerOnStartSessionComplete, <span class="type">bool</span>, bWasSuccessful);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// 我们自己自定义的委托，菜单类的回调函数可以绑定这个委托</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	FMultiplayerOnCreateSessionComplete MultiplayerOnCreateSessionComplete;</span><br><span class="line">	FMultiplayerOnFindSessionsComplete MultiplayerOnFindSessionsComplete;</span><br><span class="line">	FMultiplayerOnJoinSessionComplete MultiplayerOnJoinSessionComplete;</span><br><span class="line">	FMultiplayerOnDestroySessionComplete MultiplayerOnDestroySessionComplete;</span><br><span class="line">	FMultiplayerOnStartSessionComplete MultiplayerOnStartSessionComplete;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Menu.h</span></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// 绑定到MultiplayerSessionsSubsystem类的自定义委托的回调函数</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="built_in">UFUNCTION</span>()</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">OnCreateSession</span><span class="params">(<span class="type">bool</span> bWasSuccessful)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">OnFindSessions</span><span class="params">(<span class="type">const</span> TArray &lt;FOnlineSessionSearchResult&gt;&amp; SessionResults, <span class="type">bool</span> bWasSuccessful)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">OnJoinSession</span><span class="params">(EOnJoinSessionCompleteResult::Type Result)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UFUNCTION</span>()</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">OnDestroySession</span><span class="params">(<span class="type">bool</span> bWasSuccessful)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UFUNCTION</span>()</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">OnStartSession</span><span class="params">(<span class="type">bool</span> bWasSuccessful)</span></span>;</span><br></pre></td></tr></table></figure>
<p>可以看到，这些回调函数中有的声明了<code>UFUNCTION</code>，有的没有。这是因为在声明委托时，有的声明为了动态多播委托，而<strong>动态多播委托必须绑定<code>UFUNCTION</code>，参数中的类也必须是<code>UCLASS</code>或者<code>USTRUCT</code></strong>。然而<strong>在发现会话的委托和加入会话的委托中，我们想要传递的参数并不是<code>UCLASS</code>或者<code>USTRUCT</code>，所以无法使用动态多播，只能声明为多播，因此绑定的函数也不能声明为<code>UFUNCTION</code></strong>。</p>
<blockquote>
<p><code>DECLARE_DYNAMIC_MULTICAST_DELEGATE</code>（动态多播委托）与 <code>DECLARE_MULTICAST_DELEGATE</code>（普通多播）之间的主要差别在于<strong>是否依赖反射系统（Reflection）并可被蓝图/序列化访问</strong>：</p>
<ul>
<li><p><strong>动态（Dynamic）多播委托</strong>：可以在蓝图中绑定/触发（可标为 <code>UPROPERTY</code>），需要绑定的回调函数用 <code>UFUNCTION</code> 声明，并且参数类型必须是反射系统可识别的类型（<code>UCLASS</code>、<code>USTRUCT</code>、基础类型等）。优点是可序列化、能与蓝图交互；缺点是运行时开销略大（使用 <code>FScriptDelegate</code>），不能承载任意 C++ 类型参数。</p>
</li>
<li><p><strong>普通（非动态）多播委托</strong>：纯 C++，允许任意 C++ 参数类型（例如 <code>FOnlineSessionSearchResult</code>），性能更好，但不能直接在蓝图绑定或序列化。</p>
</li>
</ul>
<pre><code>如果委托需要暴露给 UMG / Blueprint（比如在蓝图里直接绑定），使用动态多播；如果是纯 C++ 的高频回调或参数类型不被反射支持，推荐使用普通多播。
</code></pre></blockquote>
<p>在菜单建立的函数中，将回调函数和<code>MultiplayerSessionsSubsystem</code>类中自定义的委托进行绑定。<strong>根据委托是否是动态的，绑定方式也有所区别。</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//绑定回调函数</span></span><br><span class="line"><span class="keyword">if</span> (MultiplayerSessionsSubsystem) &#123;</span><br><span class="line">	MultiplayerSessionsSubsystem-&gt;MultiplayerOnCreateSessionComplete.<span class="built_in">AddDynamic</span>(<span class="keyword">this</span>, &amp;ThisClass::OnCreateSession);</span><br><span class="line">	MultiplayerSessionsSubsystem-&gt;MultiplayerOnFindSessionsComplete.<span class="built_in">AddUObject</span>(<span class="keyword">this</span>, &amp;ThisClass::OnFindSessions);</span><br><span class="line">	MultiplayerSessionsSubsystem-&gt;MultiplayerOnJoinSessionComplete.<span class="built_in">AddUObject</span>(<span class="keyword">this</span>, &amp;ThisClass::OnJoinSession);</span><br><span class="line">	MultiplayerSessionsSubsystem-&gt;MultiplayerOnDestroySessionComplete.<span class="built_in">AddDynamic</span>(<span class="keyword">this</span>, &amp;ThisClass::OnDestroySession);</span><br><span class="line">	MultiplayerSessionsSubsystem-&gt;MultiplayerOnStartSessionComplete.<span class="built_in">AddDynamic</span>(<span class="keyword">this</span>, &amp;ThisClass::OnStartSession);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样一来，<code>MultiplayerSessionsSubsystem</code>类就可以与<code>Menu</code>类进行通话了。在<code>MultiplayerSessionsSubsystem</code>类中创建会话时，如果创建失败，需要广播自定义委托并传入参数<code>false</code>，这样菜单就知道：创建会话失败了。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!SessionInterface-&gt;<span class="built_in">CreateSession</span>(*LocalPlayer-&gt;<span class="built_in">GetPreferredUniqueNetId</span>(), NAME_GameSession, *LastSessionSettings)) &#123;</span><br><span class="line">	SessionInterface-&gt;<span class="built_in">ClearOnCreateSessionCompleteDelegate_Handle</span>(CreateSessionCompleteDelegateHandle);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//广播我们的自定义委托</span></span><br><span class="line">	MultiplayerOnCreateSessionComplete.<span class="built_in">Broadcast</span>(<span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果没有失败，<code>MultiplayerSessionsSubsystem</code>类需要在创建会话的回调函数中广播委托，告诉菜单会话有没有创建成功。<strong>在这之前还要先解绑创建会话的委托</strong>。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">UMultiplayerSessionsSubsystem::OnCreateSessionComplete</span><span class="params">(FName SessionName, <span class="type">bool</span> bWasSuccessful)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (SessionInterface) &#123;</span><br><span class="line">		SessionInterface-&gt;<span class="built_in">ClearOnCreateSessionCompleteDelegate_Handle</span>(CreateSessionCompleteDelegateHandle);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	MultiplayerOnCreateSessionComplete.<span class="built_in">Broadcast</span>(bWasSuccessful);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>Menu</code>类中的发现会话的函数中，我们接收到了<code>MultiplayerSessionsSubsystem</code>类传来的信息。如果创建成功了，就传送到大厅并设为监听服务器。传送完成后，还需要清除菜单并使玩家能够控制菜单。这部分逻辑放在<code>MenuTearDown</code>函数中实现，这个函数在<code>NativeDestruct</code>函数中被调用，而<code>NativaDestrcut</code>函数会在离开地图时被自动调用。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">UMenu::OnCreateSession</span><span class="params">(<span class="type">bool</span> bWasSuccessful)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (bWasSuccessful) &#123;</span><br><span class="line">		<span class="keyword">if</span> (GEngine) &#123;</span><br><span class="line">			GEngine-&gt;<span class="built_in">AddOnScreenDebugMessage</span>(</span><br><span class="line">				<span class="number">-1</span>,</span><br><span class="line">				<span class="number">15.f</span>,</span><br><span class="line">				FColor::Yellow,</span><br><span class="line">				<span class="built_in">FString</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Session created successfully!&quot;</span>))</span><br><span class="line">			);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		UWorld* World = <span class="built_in">GetWorld</span>();</span><br><span class="line">		<span class="keyword">if</span> (World) &#123;</span><br><span class="line">			World-&gt;<span class="built_in">ServerTravel</span>(PathToLobby);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (GEngine) &#123;</span><br><span class="line">			GEngine-&gt;<span class="built_in">AddOnScreenDebugMessage</span>(</span><br><span class="line">				<span class="number">-1</span>,</span><br><span class="line">				<span class="number">15.f</span>,</span><br><span class="line">				FColor::Red,</span><br><span class="line">				<span class="built_in">FString</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Failed to create session!&quot;</span>))</span><br><span class="line">			);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UMenu::NativeDestruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">MenuTearDown</span>();</span><br><span class="line">	Super::<span class="built_in">NativeDestruct</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UMenu::MenuTearDown</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">RemoveFromParent</span>();</span><br><span class="line">	UWorld* World = <span class="built_in">GetWorld</span>();</span><br><span class="line">	<span class="keyword">if</span> (World) &#123;</span><br><span class="line">		APlayerController* PlayerController = World-&gt;<span class="built_in">GetFirstPlayerController</span>();</span><br><span class="line">		<span class="keyword">if</span> (PlayerController) &#123;</span><br><span class="line">			FInputModeGameOnly InputModeData;</span><br><span class="line">			PlayerController-&gt;<span class="built_in">SetInputMode</span>(InputModeData);</span><br><span class="line">			PlayerController-&gt;<span class="built_in">SetShowMouseCursor</span>(<span class="literal">false</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-4-加入会话"><a href="#3-4-加入会话" class="headerlink" title="3.4 加入会话"></a>3.4 加入会话</h3><p>创建会话后，需要实现加入会话的功能。当<code>Join</code>按钮被按下后，回调函数中会执行：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (MultiplayerSessionsSubsystem) &#123;</span><br><span class="line">	MultiplayerSessionsSubsystem-&gt;<span class="built_in">FindSessions</span>(<span class="number">10000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发现会话的实现如下，和之前的逻辑差不多，直接放代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">UMultiplayerSessionsSubsystem::FindSessions</span><span class="params">(<span class="type">int</span> MaxSearchResults)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!SessionInterface.<span class="built_in">IsValid</span>()) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	FindSessionsCompleteDelegateHandle = SessionInterface-&gt;<span class="built_in">AddOnFindSessionsCompleteDelegate_Handle</span>(FindSessionsCompleteDelegate); <span class="comment">//保存句柄</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//会话搜索设置</span></span><br><span class="line">	LastSessionSearch = <span class="built_in">MakeShareable</span>(<span class="keyword">new</span> <span class="built_in">FOnlineSessionSearch</span>());</span><br><span class="line">	LastSessionSearch-&gt;MaxSearchResults = MaxSearchResults;</span><br><span class="line">	LastSessionSearch-&gt;bIsLanQuery = IOnlineSubsystem::<span class="built_in">Get</span>()-&gt;<span class="built_in">GetSubsystemName</span>() == <span class="string">&quot;NULL&quot;</span>;</span><br><span class="line">	LastSessionSearch-&gt;QuerySettings.<span class="built_in">Set</span>(SEARCH_PRESENCE, <span class="literal">true</span>, EOnlineComparisonOp::Equals);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//搜索会话。如果搜索失败，委托解绑并向菜单广播创建失败</span></span><br><span class="line">	<span class="type">const</span> ULocalPlayer* LocalPlayer = <span class="built_in">GetWorld</span>()-&gt;<span class="built_in">GetFirstLocalPlayerFromController</span>();</span><br><span class="line">	<span class="keyword">if</span> (!SessionInterface-&gt;<span class="built_in">FindSessions</span>(*LocalPlayer-&gt;<span class="built_in">GetPreferredUniqueNetId</span>(), LastSessionSearch.<span class="built_in">ToSharedRef</span>())) &#123;</span><br><span class="line">		SessionInterface-&gt;<span class="built_in">ClearOnFindSessionsCompleteDelegate_Handle</span>(FindSessionsCompleteDelegateHandle);</span><br><span class="line"></span><br><span class="line">		MultiplayerOnFindSessionsComplete.<span class="built_in">Broadcast</span>(<span class="built_in">TArray</span>&lt;FOnlineSessionSearchResult&gt;(), <span class="literal">false</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果没有失败，会执行发现会话的回调函数，如果没有发现会话，直接返回，否则将搜索结果作为参数进行广播，调用菜单类的发现会话的回调函数。注意新版UE5在这里要对搜索结果手动将<code>bUseLobbiesIfAvailable</code>设为true，因为不知道什么时候会自动变成false。如果这里不改回来，将无法加入会话。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">UMultiplayerSessionsSubsystem::OnFindSessionsComplete</span><span class="params">(<span class="type">bool</span> bWasSuccessful)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (SessionInterface) &#123;</span><br><span class="line">		SessionInterface-&gt;<span class="built_in">ClearOnFindSessionsCompleteDelegate_Handle</span>(FindSessionsCompleteDelegateHandle);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//如果没有找到会话，返回失败</span></span><br><span class="line">	<span class="keyword">if</span> (LastSessionSearch-&gt;SearchResults.<span class="built_in">Num</span>() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">		MultiplayerOnFindSessionsComplete.<span class="built_in">Broadcast</span>(<span class="built_in">TArray</span>&lt;FOnlineSessionSearchResult&gt;(), <span class="literal">false</span>);</span><br><span class="line">		<span class="keyword">if</span> (GEngine) &#123;</span><br><span class="line">			GEngine-&gt;<span class="built_in">AddOnScreenDebugMessage</span>(</span><br><span class="line">				<span class="number">-1</span>,</span><br><span class="line">				<span class="number">1.f</span>,</span><br><span class="line">				FColor::Red,</span><br><span class="line">				<span class="built_in">FString</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Session not found!&quot;</span>))</span><br><span class="line">			);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">auto</span>&amp; Result : LastSessionSearch-&gt;SearchResults)</span><br><span class="line">	&#123;</span><br><span class="line">		Result.Session.SessionSettings.bUseLobbiesIfAvailable = <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	MultiplayerOnFindSessionsComplete.<span class="built_in">Broadcast</span>(LastSessionSearch-&gt;SearchResults, bWasSuccessful);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>菜单类的回调函数，如果找到匹配的会话，直接通过接口加入会话：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">UMenu::OnFindSessions</span><span class="params">(<span class="type">const</span> TArray&lt;FOnlineSessionSearchResult&gt;&amp; SessionResults, <span class="type">bool</span> bWasSuccessful)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!MultiplayerSessionsSubsystem) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//遍历搜索结果，如果找到了匹配的会话，直接通过接口加入会话</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; Result : SessionResults) &#123;</span><br><span class="line">		FString SettingsValue;</span><br><span class="line">		Result.Session.SessionSettings.<span class="built_in">Get</span>(<span class="built_in">FName</span>(<span class="string">&quot;MatchType&quot;</span>), SettingsValue);</span><br><span class="line">		<span class="keyword">if</span> (SettingsValue == MatchType) &#123;</span><br><span class="line">			</span><br><span class="line">			MultiplayerSessionsSubsystem-&gt;<span class="built_in">JoinSessions</span>(Result);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>加入会话的函数实现如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">UMultiplayerSessionsSubsystem::JoinSessions</span><span class="params">(<span class="type">const</span> FOnlineSessionSearchResult&amp; SessionResult)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!SessionInterface.<span class="built_in">IsValid</span>()) &#123;</span><br><span class="line">		MultiplayerOnJoinSessionComplete.<span class="built_in">Broadcast</span>(EOnJoinSessionCompleteResult::UnknownError);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//保存句柄</span></span><br><span class="line">	JoinSessionCompleteDelegateHandle = SessionInterface-&gt;<span class="built_in">AddOnJoinSessionCompleteDelegate_Handle</span>(JoinSessionCompleteDelegate);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//通过在线会话接口加入会话，如果失败就委托解绑，广播加入会话失败</span></span><br><span class="line">	<span class="type">const</span> ULocalPlayer* LocalPlayer = <span class="built_in">GetWorld</span>()-&gt;<span class="built_in">GetFirstLocalPlayerFromController</span>();</span><br><span class="line">	<span class="keyword">if</span> (!SessionInterface-&gt;<span class="built_in">JoinSession</span>(*LocalPlayer-&gt;<span class="built_in">GetPreferredUniqueNetId</span>(), NAME_GameSession, SessionResult)) &#123;</span><br><span class="line">		SessionInterface-&gt;<span class="built_in">ClearOnJoinSessionCompleteDelegate_Handle</span>(JoinSessionCompleteDelegateHandle);</span><br><span class="line">		MultiplayerOnJoinSessionComplete.<span class="built_in">Broadcast</span>(EOnJoinSessionCompleteResult::UnknownError);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在回调函数中向菜单类广播结果。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">UMultiplayerSessionsSubsystem::OnJoinSessionComplete</span><span class="params">(FName SessionName, EOnJoinSessionCompleteResult::Type Result)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!SessionInterface) &#123;</span><br><span class="line">		SessionInterface-&gt;<span class="built_in">ClearOnJoinSessionCompleteDelegate_Handle</span>(JoinSessionCompleteDelegateHandle);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	MultiplayerOnJoinSessionComplete.<span class="built_in">Broadcast</span>(Result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在菜单类的回调函数中调用<code>ClientTravel</code>将客户端传送到主机。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">UMenu::OnJoinSession</span><span class="params">(EOnJoinSessionCompleteResult::Type Result)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	IOnlineSubsystem* Subsystem = IOnlineSubsystem::<span class="built_in">Get</span>();</span><br><span class="line">	<span class="keyword">if</span> (Subsystem) &#123;</span><br><span class="line">		IOnlineSessionPtr SessionInterface = Subsystem-&gt;<span class="built_in">GetSessionInterface</span>();</span><br><span class="line">		<span class="keyword">if</span> (SessionInterface.<span class="built_in">IsValid</span>()) &#123;</span><br><span class="line">			FString Address;</span><br><span class="line">			SessionInterface-&gt;<span class="built_in">GetResolvedConnectString</span>(NAME_GameSession, Address);</span><br><span class="line">			<span class="keyword">if</span> (Address == <span class="built_in">FString</span>()) &#123;</span><br><span class="line">				<span class="keyword">if</span> (GEngine) &#123;</span><br><span class="line">					GEngine-&gt;<span class="built_in">AddOnScreenDebugMessage</span>(</span><br><span class="line">						<span class="number">-1</span>,</span><br><span class="line">						<span class="number">15.f</span>,</span><br><span class="line">						FColor::Red,</span><br><span class="line">						<span class="built_in">FString</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Address not found!&quot;</span>))</span><br><span class="line">					);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			APlayerController* PlayerController = <span class="built_in">GetGameInstance</span>()-&gt;<span class="built_in">GetFirstLocalPlayerController</span>();</span><br><span class="line">			<span class="keyword">if</span> (PlayerController) &#123;</span><br><span class="line">				PlayerController-&gt;<span class="built_in">ClientTravel</span>(Address, ETravelType::TRAVEL_Absolute);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样从创建会话到加入会话的功能就全部完成了。</p>
<h3 id="3-5-销毁会话"><a href="#3-5-销毁会话" class="headerlink" title="3.5 销毁会话"></a>3.5 销毁会话</h3><p>解绑委托后直接使用在线会话接口销毁会话即可。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">UMultiplayerSessionsSubsystem::DestroySession</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!SessionInterface.<span class="built_in">IsValid</span>()) &#123;</span><br><span class="line">		MultiplayerOnDestroySessionComplete.<span class="built_in">Broadcast</span>(<span class="literal">false</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	DestroySessionCompleteDelegateHandle = SessionInterface-&gt;<span class="built_in">AddOnDestroySessionCompleteDelegate_Handle</span>(DestroySessionCompleteDelegate);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!SessionInterface-&gt;<span class="built_in">DestroySession</span>(NAME_GameSession)) &#123;</span><br><span class="line">		SessionInterface-&gt;<span class="built_in">ClearOnDestroySessionCompleteDelegate_Handle</span>(DestroySessionCompleteDelegateHandle);</span><br><span class="line">		MultiplayerOnDestroySessionComplete.<span class="built_in">Broadcast</span>(<span class="literal">false</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在回调函数中将<code>bCreateSessionOnDestroy</code>设为false，表示当前没有要销毁的会话，然后通过成员变量保存的信息创建会话。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">UMultiplayerSessionsSubsystem::OnDestroySessionComplete</span><span class="params">(FName SessionName, <span class="type">bool</span> bWasSuccessful)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (SessionInterface) &#123;</span><br><span class="line">		SessionInterface-&gt;<span class="built_in">ClearOnDestroySessionCompleteDelegate_Handle</span>(DestroySessionCompleteDelegateHandle);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (bWasSuccessful &amp;&amp; bCreateSessionOnDestroy) &#123;</span><br><span class="line">		bCreateSessionOnDestroy = <span class="literal">false</span>;</span><br><span class="line">		<span class="built_in">CreateSession</span>(LastNumPublicConnections, LastMatchType);</span><br><span class="line">	&#125;</span><br><span class="line">	MultiplayerOnDestroySessionComplete.<span class="built_in">Broadcast</span>(bWasSuccessful);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-6-收尾"><a href="#3-6-收尾" class="headerlink" title="3.6 收尾"></a>3.6 收尾</h3><p>菜单中有一个瑕疵：<code>Host</code>按钮和<code>Join</code>按钮可以被反复按下，而在加入会话和搜寻会话的过程中，我们是不希望按钮被按下的，这是我们要限制按钮的功能。主要是通过向按钮的<code>SetIsEnabled</code>函数中传入<code>true</code>和<code>false</code>来控制按钮的可用性。</p>
<p>当按下创建会话按钮后需要将按钮设为不可用，直到回调函数中返回“创建会话失败”再设为可用，表示可以重新尝试创建会话了。</p>
<p>按下加入会话按钮后同样将按钮设为不可用，当回调函数中返回“加入会话失败”再设为可用，表示可以重新尝试加入会话。</p>
<p>当修补了这个小瑕疵后，插件的功能就完成的差不多了。当安装插件后，可以直接通过菜单的两个按钮实现联机，也可以通过调用<code>MultiplayerSessionsSubsystem</code>来实现更多功能。</p>
<h2 id="4-完整代码"><a href="#4-完整代码" class="headerlink" title="4.完整代码"></a>4.完整代码</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MenuSystemCharacter.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;CoreMinimal.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;GameFramework/Character.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Logging/LogMacros.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Interfaces/OnlineSessionInterface.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;MenuSystemCharacter.generated.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">USpringArmComponent</span>;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UCameraComponent</span>;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UInputMappingContext</span>;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UInputAction</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">FInputActionValue</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">DECLARE_LOG_CATEGORY_EXTERN</span>(LogTemplateCharacter, Log, All);</span><br><span class="line"></span><br><span class="line"><span class="built_in">UCLASS</span>(config=Game)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AMenuSystemCharacter</span> : <span class="keyword">public</span> ACharacter</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Camera boom positioning the camera behind the character */</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(VisibleAnywhere, BlueprintReadOnly, Category = Camera, meta = (AllowPrivateAccess = <span class="string">&quot;true&quot;</span>))</span><br><span class="line">	USpringArmComponent* CameraBoom;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Follow camera */</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(VisibleAnywhere, BlueprintReadOnly, Category = Camera, meta = (AllowPrivateAccess = <span class="string">&quot;true&quot;</span>))</span><br><span class="line">	UCameraComponent* FollowCamera;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/** MappingContext */</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(EditAnywhere, BlueprintReadOnly, Category = Input, meta = (AllowPrivateAccess = <span class="string">&quot;true&quot;</span>))</span><br><span class="line">	UInputMappingContext* DefaultMappingContext;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Jump Input Action */</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(EditAnywhere, BlueprintReadOnly, Category = Input, meta = (AllowPrivateAccess = <span class="string">&quot;true&quot;</span>))</span><br><span class="line">	UInputAction* JumpAction;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Move Input Action */</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(EditAnywhere, BlueprintReadOnly, Category = Input, meta = (AllowPrivateAccess = <span class="string">&quot;true&quot;</span>))</span><br><span class="line">	UInputAction* MoveAction;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Look Input Action */</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(EditAnywhere, BlueprintReadOnly, Category = Input, meta = (AllowPrivateAccess = <span class="string">&quot;true&quot;</span>))</span><br><span class="line">	UInputAction* LookAction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">AMenuSystemCharacter</span>();</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Called for movement input */</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">Move</span><span class="params">(<span class="type">const</span> FInputActionValue&amp; Value)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Called for looking input */</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">Look</span><span class="params">(<span class="type">const</span> FInputActionValue&amp; Value)</span></span>;</span><br><span class="line">			</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">NotifyControllerChanged</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">SetupPlayerInputComponent</span><span class="params">(<span class="keyword">class</span> UInputComponent* PlayerInputComponent)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="comment">/** Returns CameraBoom subobject **/</span></span><br><span class="line">	<span class="function">FORCEINLINE <span class="keyword">class</span> USpringArmComponent* <span class="title">GetCameraBoom</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> CameraBoom; &#125;</span><br><span class="line">	<span class="comment">/** Returns FollowCamera subobject **/</span></span><br><span class="line">	<span class="function">FORCEINLINE <span class="keyword">class</span> UCameraComponent* <span class="title">GetFollowCamera</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> FollowCamera; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="comment">//在线会话接口的指针</span></span><br><span class="line">	IOnlineSessionPtr OnlineSessionInterface;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="built_in">UFUNCTION</span>(BlueprintCallable)</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">CreateGameSession</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UFUNCTION</span>(BlueprintCallable)</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">JoinGameSession</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* Delegate fired when a session create request has completed</span></span><br><span class="line"><span class="comment">	*</span></span><br><span class="line"><span class="comment">	* @param SessionName the name of the session this callback is for</span></span><br><span class="line"><span class="comment">	* @param bWasSuccessful true if the async action completed without error, false if there was an error</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">OnCreateSessionComplete</span><span class="params">(FName SessionName, <span class="type">bool</span> bWasSussful)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">OnFindSessionsComplete</span><span class="params">(<span class="type">bool</span> bWasSuccessful)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">OnJoinSessionComplete</span><span class="params">(FName SessionName, EOnJoinSessionCompleteResult::Type Result)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	FOnCreateSessionCompleteDelegate CreateSessionCompleteDelegate;</span><br><span class="line">	FOnFindSessionsCompleteDelegate FindSessionsCompleteDelegate;</span><br><span class="line">	TSharedPtr&lt;FOnlineSessionSearch&gt; SessionSearch;</span><br><span class="line">	FOnJoinSessionCompleteDelegate JoinSessionCompleteDelegate;</span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MenuSystemCharacter.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;MenuSystemCharacter.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Engine/LocalPlayer.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Camera/CameraComponent.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Components/CapsuleComponent.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;GameFramework/CharacterMovementComponent.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;GameFramework/SpringArmComponent.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;GameFramework/Controller.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;EnhancedInputComponent.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;EnhancedInputSubsystems.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;InputActionValue.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;OnlineSubsystem.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;OnlineSessionSettings.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Online/OnlineSessionNames.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">DEFINE_LOG_CATEGORY</span>(LogTemplateCharacter);</span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// AMenuSystemCharacter</span></span><br><span class="line"></span><br><span class="line">AMenuSystemCharacter::<span class="built_in">AMenuSystemCharacter</span>() :</span><br><span class="line">	<span class="built_in">CreateSessionCompleteDelegate</span>(FOnCreateSessionCompleteDelegate::<span class="built_in">CreateUObject</span>(<span class="keyword">this</span>, &amp;ThisClass::OnCreateSessionComplete)),</span><br><span class="line">	<span class="built_in">FindSessionsCompleteDelegate</span>(FOnFindSessionsCompleteDelegate::<span class="built_in">CreateUObject</span>(<span class="keyword">this</span>, &amp;ThisClass::OnFindSessionsComplete)),</span><br><span class="line">	<span class="built_in">JoinSessionCompleteDelegate</span>(FOnJoinSessionCompleteDelegate::<span class="built_in">CreateUObject</span>(<span class="keyword">this</span>, &amp;ThisClass::OnJoinSessionComplete))</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// Set size for collision capsule</span></span><br><span class="line">	<span class="built_in">GetCapsuleComponent</span>()-&gt;<span class="built_in">InitCapsuleSize</span>(<span class="number">42.f</span>, <span class="number">96.0f</span>);</span><br><span class="line">		</span><br><span class="line">	<span class="comment">// Don&#x27;t rotate when the controller rotates. Let that just affect the camera.</span></span><br><span class="line">	bUseControllerRotationPitch = <span class="literal">false</span>;</span><br><span class="line">	bUseControllerRotationYaw = <span class="literal">false</span>;</span><br><span class="line">	bUseControllerRotationRoll = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Configure character movement</span></span><br><span class="line">	<span class="built_in">GetCharacterMovement</span>()-&gt;bOrientRotationToMovement = <span class="literal">true</span>; <span class="comment">// Character moves in the direction of input...	</span></span><br><span class="line">	<span class="built_in">GetCharacterMovement</span>()-&gt;RotationRate = <span class="built_in">FRotator</span>(<span class="number">0.0f</span>, <span class="number">500.0f</span>, <span class="number">0.0f</span>); <span class="comment">// ...at this rotation rate</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Note: For faster iteration times these variables, and many more, can be tweaked in the Character Blueprint</span></span><br><span class="line">	<span class="comment">// instead of recompiling to adjust them</span></span><br><span class="line">	<span class="built_in">GetCharacterMovement</span>()-&gt;JumpZVelocity = <span class="number">700.f</span>;</span><br><span class="line">	<span class="built_in">GetCharacterMovement</span>()-&gt;AirControl = <span class="number">0.35f</span>;</span><br><span class="line">	<span class="built_in">GetCharacterMovement</span>()-&gt;MaxWalkSpeed = <span class="number">500.f</span>;</span><br><span class="line">	<span class="built_in">GetCharacterMovement</span>()-&gt;MinAnalogWalkSpeed = <span class="number">20.f</span>;</span><br><span class="line">	<span class="built_in">GetCharacterMovement</span>()-&gt;BrakingDecelerationWalking = <span class="number">2000.f</span>;</span><br><span class="line">	<span class="built_in">GetCharacterMovement</span>()-&gt;BrakingDecelerationFalling = <span class="number">1500.0f</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Create a camera boom (pulls in towards the player if there is a collision)</span></span><br><span class="line">	CameraBoom = <span class="built_in">CreateDefaultSubobject</span>&lt;USpringArmComponent&gt;(<span class="built_in">TEXT</span>(<span class="string">&quot;CameraBoom&quot;</span>));</span><br><span class="line">	CameraBoom-&gt;<span class="built_in">SetupAttachment</span>(RootComponent);</span><br><span class="line">	CameraBoom-&gt;TargetArmLength = <span class="number">400.0f</span>; <span class="comment">// The camera follows at this distance behind the character	</span></span><br><span class="line">	CameraBoom-&gt;bUsePawnControlRotation = <span class="literal">true</span>; <span class="comment">// Rotate the arm based on the controller</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Create a follow camera</span></span><br><span class="line">	FollowCamera = <span class="built_in">CreateDefaultSubobject</span>&lt;UCameraComponent&gt;(<span class="built_in">TEXT</span>(<span class="string">&quot;FollowCamera&quot;</span>));</span><br><span class="line">	FollowCamera-&gt;<span class="built_in">SetupAttachment</span>(CameraBoom, USpringArmComponent::SocketName); <span class="comment">// Attach the camera to the end of the boom and let the boom adjust to match the controller orientation</span></span><br><span class="line">	FollowCamera-&gt;bUsePawnControlRotation = <span class="literal">false</span>; <span class="comment">// Camera does not rotate relative to arm</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Note: The skeletal mesh and anim blueprint references on the Mesh component (inherited from Character) </span></span><br><span class="line">	<span class="comment">// are set in the derived blueprint asset named ThirdPersonCharacter (to avoid direct content references in C++)</span></span><br><span class="line"></span><br><span class="line">	IOnlineSubsystem* OnlineSubsystem = IOnlineSubsystem::<span class="built_in">Get</span>();</span><br><span class="line">	<span class="keyword">if</span> (OnlineSubsystem) &#123;</span><br><span class="line">		OnlineSessionInterface = OnlineSubsystem-&gt;<span class="built_in">GetSessionInterface</span>();</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*if (GEngine) &#123;</span></span><br><span class="line"><span class="comment">			GEngine-&gt;AddOnScreenDebugMessage(</span></span><br><span class="line"><span class="comment">				-1,</span></span><br><span class="line"><span class="comment">				15.f,</span></span><br><span class="line"><span class="comment">				FColor::Blue,</span></span><br><span class="line"><span class="comment">				FString::Printf(TEXT(&quot;Found subsystem %s&quot;), *OnlineSubsystem-&gt;GetSubsystemName().ToString())</span></span><br><span class="line"><span class="comment">			);</span></span><br><span class="line"><span class="comment">		&#125;*/</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// Input</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">AMenuSystemCharacter::NotifyControllerChanged</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Super::<span class="built_in">NotifyControllerChanged</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Add Input Mapping Context</span></span><br><span class="line">	<span class="keyword">if</span> (APlayerController* PlayerController = <span class="built_in">Cast</span>&lt;APlayerController&gt;(Controller))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (UEnhancedInputLocalPlayerSubsystem* Subsystem = ULocalPlayer::<span class="built_in">GetSubsystem</span>&lt;UEnhancedInputLocalPlayerSubsystem&gt;(PlayerController-&gt;<span class="built_in">GetLocalPlayer</span>()))</span><br><span class="line">		&#123;</span><br><span class="line">			Subsystem-&gt;<span class="built_in">AddMappingContext</span>(DefaultMappingContext, <span class="number">0</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">AMenuSystemCharacter::SetupPlayerInputComponent</span><span class="params">(UInputComponent* PlayerInputComponent)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// Set up action bindings</span></span><br><span class="line">	<span class="keyword">if</span> (UEnhancedInputComponent* EnhancedInputComponent = <span class="built_in">Cast</span>&lt;UEnhancedInputComponent&gt;(PlayerInputComponent)) &#123;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// Jumping</span></span><br><span class="line">		EnhancedInputComponent-&gt;<span class="built_in">BindAction</span>(JumpAction, ETriggerEvent::Started, <span class="keyword">this</span>, &amp;ACharacter::Jump);</span><br><span class="line">		EnhancedInputComponent-&gt;<span class="built_in">BindAction</span>(JumpAction, ETriggerEvent::Completed, <span class="keyword">this</span>, &amp;ACharacter::StopJumping);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Moving</span></span><br><span class="line">		EnhancedInputComponent-&gt;<span class="built_in">BindAction</span>(MoveAction, ETriggerEvent::Triggered, <span class="keyword">this</span>, &amp;AMenuSystemCharacter::Move);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Looking</span></span><br><span class="line">		EnhancedInputComponent-&gt;<span class="built_in">BindAction</span>(LookAction, ETriggerEvent::Triggered, <span class="keyword">this</span>, &amp;AMenuSystemCharacter::Look);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">UE_LOG</span>(LogTemplateCharacter, Error, <span class="built_in">TEXT</span>(<span class="string">&quot;&#x27;%s&#x27; Failed to find an Enhanced Input component! This template is built to use the Enhanced Input system. If you intend to use the legacy system, then you will need to update this C++ file.&quot;</span>), *<span class="built_in">GetNameSafe</span>(<span class="keyword">this</span>));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建会话</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">AMenuSystemCharacter::CreateGameSession</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//按“1”调用函数</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">//检查指针是否有效</span></span><br><span class="line">	<span class="keyword">if</span> (!OnlineSessionInterface.<span class="built_in">IsValid</span>()) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//检查当前是否存在会话，如果有，将其销毁</span></span><br><span class="line">	<span class="keyword">auto</span> ExistingSession = OnlineSessionInterface-&gt;<span class="built_in">GetNamedSession</span>(NAME_GameSession);</span><br><span class="line">	<span class="keyword">if</span> (ExistingSession) &#123;</span><br><span class="line">		OnlineSessionInterface-&gt;<span class="built_in">DestroySession</span>(NAME_GameSession);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//将委托添加到列表，进行会话设置，创建会话</span></span><br><span class="line">	OnlineSessionInterface-&gt;<span class="built_in">AddOnCreateSessionCompleteDelegate_Handle</span>(CreateSessionCompleteDelegate);</span><br><span class="line"></span><br><span class="line">	TSharedPtr&lt;FOnlineSessionSettings&gt; SessionSettings = <span class="built_in">MakeShareable</span>(<span class="keyword">new</span> <span class="built_in">FOnlineSessionSettings</span>());</span><br><span class="line">	SessionSettings-&gt;bIsLANMatch = <span class="literal">false</span>; <span class="comment">//是否为局域网匹配</span></span><br><span class="line">	SessionSettings-&gt;NumPublicConnections = <span class="number">4</span>; <span class="comment">//最大联机数量</span></span><br><span class="line">	SessionSettings-&gt;bAllowJoinInProgress = <span class="literal">true</span>; <span class="comment">//是否允许中途加入</span></span><br><span class="line">	SessionSettings-&gt;bAllowJoinViaPresence = <span class="literal">true</span>; <span class="comment">//是否允许通过 Steam 好友加入</span></span><br><span class="line">	SessionSettings-&gt;bShouldAdvertise = <span class="literal">true</span>; <span class="comment">//是否将房间暴露出去</span></span><br><span class="line">	SessionSettings-&gt;bUsesPresence = <span class="literal">true</span>; <span class="comment">//是否使用“在线状态系统”</span></span><br><span class="line">	SessionSettings-&gt;bUseLobbiesIfAvailable = <span class="literal">true</span>; <span class="comment">//是否使用 Steam Lobby 功能</span></span><br><span class="line">	SessionSettings-&gt;<span class="built_in">Set</span>(<span class="built_in">FName</span>(<span class="string">&quot;MatchType&quot;</span>), <span class="built_in">FString</span>(<span class="string">&quot;FreeForAll&quot;</span>), EOnlineDataAdvertisementType::ViaOnlineServiceAndPing);</span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> ULocalPlayer* localPlayer = <span class="built_in">GetWorld</span>()-&gt;<span class="built_in">GetFirstLocalPlayerFromController</span>();</span><br><span class="line">	OnlineSessionInterface-&gt;<span class="built_in">CreateSession</span>(*localPlayer-&gt;<span class="built_in">GetPreferredUniqueNetId</span>(), NAME_GameSession, *SessionSettings);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//加入会话</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">AMenuSystemCharacter::JoinGameSession</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!OnlineSessionInterface.<span class="built_in">IsValid</span>()) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	OnlineSessionInterface-&gt;<span class="built_in">AddOnFindSessionsCompleteDelegate_Handle</span>(FindSessionsCompleteDelegate);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//寻找会话</span></span><br><span class="line">	SessionSearch = <span class="built_in">MakeShareable</span>(<span class="keyword">new</span> <span class="built_in">FOnlineSessionSearch</span>());</span><br><span class="line">	SessionSearch-&gt;MaxSearchResults = <span class="number">10000</span>; <span class="comment">//最多查找多少个房间</span></span><br><span class="line">	SessionSearch-&gt;bIsLanQuery = <span class="literal">false</span>; <span class="comment">//是否为局域网查找</span></span><br><span class="line">	SessionSearch-&gt;QuerySettings.<span class="built_in">Set</span>(SEARCH_PRESENCE, <span class="literal">true</span>, EOnlineComparisonOp::Equals); <span class="comment">//查找支持好友加入/展示的房间</span></span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> ULocalPlayer* LocalPlayer = <span class="built_in">GetWorld</span>()-&gt;<span class="built_in">GetFirstLocalPlayerFromController</span>();</span><br><span class="line">	OnlineSessionInterface-&gt;<span class="built_in">FindSessions</span>(*LocalPlayer-&gt;<span class="built_in">GetPreferredUniqueNetId</span>(), SessionSearch.<span class="built_in">ToSharedRef</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建会话的回调函数</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">AMenuSystemCharacter::OnCreateSessionComplete</span><span class="params">(FName SessionName, <span class="type">bool</span> bWasSussful)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (bWasSussful) &#123;</span><br><span class="line">		<span class="keyword">if</span> (GEngine) &#123;</span><br><span class="line">			GEngine-&gt;<span class="built_in">AddOnScreenDebugMessage</span>(</span><br><span class="line">				<span class="number">-1</span>,</span><br><span class="line">				<span class="number">15.f</span>,</span><br><span class="line">				FColor::Blue,</span><br><span class="line">				FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Created session: %s&quot;</span>),*SessionName.<span class="built_in">ToString</span>())</span><br><span class="line">			);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		UWorld* world = <span class="built_in">GetWorld</span>();</span><br><span class="line">		<span class="keyword">if</span> (world) &#123;</span><br><span class="line">			world-&gt;<span class="built_in">ServerTravel</span>(<span class="built_in">FString</span>(<span class="string">&quot;/Game/ThirdPerson/Maps/Lobby?listen&quot;</span>)); <span class="comment">//打开大厅地图并设为服务器</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (GEngine) &#123;</span><br><span class="line">			GEngine-&gt;<span class="built_in">AddOnScreenDebugMessage</span>(</span><br><span class="line">				<span class="number">-1</span>,</span><br><span class="line">				<span class="number">15.f</span>,</span><br><span class="line">				FColor::Red,</span><br><span class="line">				<span class="built_in">FString</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Failed to create session!&quot;</span>))</span><br><span class="line">			);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//发现会话的回调函数</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">AMenuSystemCharacter::OnFindSessionsComplete</span><span class="params">(<span class="type">bool</span> bWasSuccessful)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!OnlineSessionInterface.<span class="built_in">IsValid</span>()) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">auto</span> Result : SessionSearch-&gt;SearchResults) &#123;</span><br><span class="line">		FString Id = Result.<span class="built_in">GetSessionIdStr</span>(); <span class="comment">//获得会话ID</span></span><br><span class="line">		FString User = Result.Session.OwningUserName; <span class="comment">//获得会话拥有者</span></span><br><span class="line">		FString MatchType;</span><br><span class="line">		Result.Session.SessionSettings.<span class="built_in">Get</span>(<span class="built_in">FName</span>(<span class="string">&quot;MatchType&quot;</span>), MatchType); <span class="comment">//获取比赛类型</span></span><br><span class="line">		<span class="keyword">if</span>(GEngine) &#123;</span><br><span class="line">			GEngine-&gt;<span class="built_in">AddOnScreenDebugMessage</span>(</span><br><span class="line">				<span class="number">-1</span>,</span><br><span class="line">				<span class="number">15.f</span>,</span><br><span class="line">				FColor::Cyan,</span><br><span class="line">				FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Id: %s, User: %s&quot;</span>), *Id, *User)</span><br><span class="line">			);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//检查比赛类型是否是FreeForAll</span></span><br><span class="line">		<span class="keyword">if</span> (MatchType == <span class="built_in">FString</span>(<span class="string">&quot;FreeForAll&quot;</span>)) &#123;</span><br><span class="line">			<span class="keyword">if</span> (GEngine) &#123;</span><br><span class="line">				GEngine-&gt;<span class="built_in">AddOnScreenDebugMessage</span>(</span><br><span class="line">					<span class="number">-1</span>,</span><br><span class="line">					<span class="number">15.f</span>,</span><br><span class="line">					FColor::Cyan,</span><br><span class="line">					FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Joing Match Type: %s&quot;</span>), *MatchType)</span><br><span class="line">				);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			OnlineSessionInterface-&gt;<span class="built_in">AddOnJoinSessionCompleteDelegate_Handle</span>(JoinSessionCompleteDelegate);</span><br><span class="line"></span><br><span class="line">			<span class="type">const</span> ULocalPlayer* localPlayer = <span class="built_in">GetWorld</span>()-&gt;<span class="built_in">GetFirstLocalPlayerFromController</span>();</span><br><span class="line">			OnlineSessionInterface-&gt;<span class="built_in">JoinSession</span>(*localPlayer-&gt;<span class="built_in">GetPreferredUniqueNetId</span>(), NAME_GameSession, Result);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//加入会话的回调函数</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">AMenuSystemCharacter::OnJoinSessionComplete</span><span class="params">(FName SessionName, EOnJoinSessionCompleteResult::Type Result)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!OnlineSessionInterface.<span class="built_in">IsValid</span>()) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	FString Address;</span><br><span class="line">	<span class="keyword">if</span> (OnlineSessionInterface-&gt;<span class="built_in">GetResolvedConnectString</span>(NAME_GameSession, Address)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (GEngine) &#123;</span><br><span class="line">			GEngine-&gt;<span class="built_in">AddOnScreenDebugMessage</span>(</span><br><span class="line">				<span class="number">-1</span>,</span><br><span class="line">				<span class="number">15.f</span>,</span><br><span class="line">				FColor::Yellow,</span><br><span class="line">				FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Connext string: %s&quot;</span>), *Address)</span><br><span class="line">			);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		APlayerController* PlayerController = <span class="built_in">GetGameInstance</span>()-&gt;<span class="built_in">GetFirstLocalPlayerController</span>();</span><br><span class="line">		<span class="keyword">if</span> (PlayerController) &#123;</span><br><span class="line">			PlayerController-&gt;<span class="built_in">ClientTravel</span>(Address, ETravelType::TRAVEL_Absolute);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		GEngine-&gt;<span class="built_in">AddOnScreenDebugMessage</span>(</span><br><span class="line">			<span class="number">-1</span>,</span><br><span class="line">			<span class="number">15.f</span>,</span><br><span class="line">			FColor::Yellow,</span><br><span class="line">			FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Address Not Find&quot;</span>))</span><br><span class="line">		);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">AMenuSystemCharacter::Move</span><span class="params">(<span class="type">const</span> FInputActionValue&amp; Value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// input is a Vector2D</span></span><br><span class="line">	FVector2D MovementVector = Value.<span class="built_in">Get</span>&lt;FVector2D&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (Controller != <span class="literal">nullptr</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// find out which way is forward</span></span><br><span class="line">		<span class="type">const</span> FRotator Rotation = Controller-&gt;<span class="built_in">GetControlRotation</span>();</span><br><span class="line">		<span class="function"><span class="type">const</span> FRotator <span class="title">YawRotation</span><span class="params">(<span class="number">0</span>, Rotation.Yaw, <span class="number">0</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// get forward vector</span></span><br><span class="line">		<span class="type">const</span> FVector ForwardDirection = <span class="built_in">FRotationMatrix</span>(YawRotation).<span class="built_in">GetUnitAxis</span>(EAxis::X);</span><br><span class="line">	</span><br><span class="line">		<span class="comment">// get right vector </span></span><br><span class="line">		<span class="type">const</span> FVector RightDirection = <span class="built_in">FRotationMatrix</span>(YawRotation).<span class="built_in">GetUnitAxis</span>(EAxis::Y);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// add movement </span></span><br><span class="line">		<span class="built_in">AddMovementInput</span>(ForwardDirection, MovementVector.Y);</span><br><span class="line">		<span class="built_in">AddMovementInput</span>(RightDirection, MovementVector.X);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">AMenuSystemCharacter::Look</span><span class="params">(<span class="type">const</span> FInputActionValue&amp; Value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// input is a Vector2D</span></span><br><span class="line">	FVector2D LookAxisVector = Value.<span class="built_in">Get</span>&lt;FVector2D&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (Controller != <span class="literal">nullptr</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// add yaw and pitch input to controller</span></span><br><span class="line">		<span class="built_in">AddControllerYawInput</span>(LookAxisVector.X);</span><br><span class="line">		<span class="built_in">AddControllerPitchInput</span>(LookAxisVector.Y);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MultiplayerSessionsSubsystem.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;CoreMinimal.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Subsystems/GameInstanceSubsystem.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Interfaces/OnlineSessionInterface.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;MultiplayerSessionsSubsystem.generated.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 为菜单类声明我们自定义的委托，用于菜单类绑定</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="built_in">DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam</span>(FMultiplayerOnCreateSessionComplete, <span class="type">bool</span>, bWasSuccessful);</span><br><span class="line"><span class="built_in">DECLARE_MULTICAST_DELEGATE_TwoParams</span>(FMultiplayerOnFindSessionsComplete, <span class="type">const</span> TArray &lt;FOnlineSessionSearchResult&gt;&amp; SessionResults, <span class="type">bool</span> bWasSuccessful);</span><br><span class="line"><span class="built_in">DECLARE_MULTICAST_DELEGATE_OneParam</span>(FMultiplayerOnJoinSessionComplete, EOnJoinSessionCompleteResult::Type Result);</span><br><span class="line"><span class="built_in">DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam</span>(FMultiplayerOnDestroySessionComplete, <span class="type">bool</span>, bWasSuccessful);</span><br><span class="line"><span class="built_in">DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam</span>(FMultiplayerOnStartSessionComplete, <span class="type">bool</span>, bWasSuccessful);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="built_in">UCLASS</span>()</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MULTIPLAYERSESSIONS_API</span> UMultiplayerSessionsSubsystem : <span class="keyword">public</span> UGameInstanceSubsystem</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">GENERATED_BODY</span>()</span><br><span class="line">	</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">UMultiplayerSessionsSubsystem</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// 外部接口：供 UI 或其他模块调用的多人联机会话控制函数</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">CreateSession</span><span class="params">(int32 NumPublicConnections, FString MatchType)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">FindSessions</span><span class="params">(<span class="type">int</span> MaxSearchResults)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">JoinSessions</span><span class="params">(<span class="type">const</span> FOnlineSessionSearchResult&amp; SessionResult)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">DestroySession</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">StartSession</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// 我们自己自定义的委托，菜单类的回调函数可以绑定这个委托</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	FMultiplayerOnCreateSessionComplete MultiplayerOnCreateSessionComplete;</span><br><span class="line">	FMultiplayerOnFindSessionsComplete MultiplayerOnFindSessionsComplete;</span><br><span class="line">	FMultiplayerOnJoinSessionComplete MultiplayerOnJoinSessionComplete;</span><br><span class="line">	FMultiplayerOnDestroySessionComplete MultiplayerOnDestroySessionComplete;</span><br><span class="line">	FMultiplayerOnStartSessionComplete MultiplayerOnStartSessionComplete;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// 回调函数：会被 OnlineSubsystem 在异步操作完成后自动调用</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">OnCreateSessionComplete</span><span class="params">(FName SessionName, <span class="type">bool</span> bWasSuccessful)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">OnFindSessionsComplete</span><span class="params">(<span class="type">bool</span> bWasSuccessful)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">OnJoinSessionComplete</span><span class="params">(FName SessionName, EOnJoinSessionCompleteResult::Type Result)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">OnDestroySessionComplete</span><span class="params">(FName SessionName, <span class="type">bool</span> bWasSuccessful)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">OnStartSessionComplete</span><span class="params">(FName SessionName, <span class="type">bool</span> bWasSuccessful)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	IOnlineSessionPtr SessionInterface;</span><br><span class="line">	TSharedPtr&lt;FOnlineSessionSettings&gt; LastSessionSettings;</span><br><span class="line">	TSharedPtr&lt;FOnlineSessionSearch&gt; LastSessionSearch;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// 委托声明+绑定：将回调函数挂载到OnlineSubsystem的事件通知中</span></span><br><span class="line">	<span class="comment">// 每个委托都有对应的DelegateHandle用于解绑（防止重复绑定）</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	FOnCreateSessionCompleteDelegate CreateSessionCompleteDelegate;</span><br><span class="line">	FDelegateHandle CreateSessionCompleteDelegateHandle;</span><br><span class="line">	FOnFindSessionsCompleteDelegate FindSessionsCompleteDelegate;</span><br><span class="line">	FDelegateHandle FindSessionsCompleteDelegateHandle;</span><br><span class="line">	FOnJoinSessionCompleteDelegate JoinSessionCompleteDelegate;</span><br><span class="line">	FDelegateHandle JoinSessionCompleteDelegateHandle;</span><br><span class="line">	FOnDestroySessionCompleteDelegate DestroySessionCompleteDelegate;</span><br><span class="line">	FDelegateHandle DestroySessionCompleteDelegateHandle;</span><br><span class="line">	FOnStartSessionCompleteDelegate StartSessionCompleteDelegate;</span><br><span class="line">	FDelegateHandle StartSessionCompleteDelegateHandle;</span><br><span class="line"></span><br><span class="line">	<span class="type">bool</span> bCreateSessionOnDestroy = <span class="literal">false</span>;</span><br><span class="line">	int32 LastNumPublicConnections;</span><br><span class="line">	FString LastMatchType;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MultiplayerSessionsSubsystem.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;MultiplayerSessionsSubsystem.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;OnlineSubsystem.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;OnlineSessionSettings.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Online/OnlineSessionNames.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">UMultiplayerSessionsSubsystem::<span class="built_in">UMultiplayerSessionsSubsystem</span>():</span><br><span class="line">	<span class="built_in">CreateSessionCompleteDelegate</span>(FOnCreateSessionCompleteDelegate::<span class="built_in">CreateUObject</span>(<span class="keyword">this</span>,&amp;ThisClass::OnCreateSessionComplete)),</span><br><span class="line">	<span class="built_in">FindSessionsCompleteDelegate</span>(FOnFindSessionsCompleteDelegate::<span class="built_in">CreateUObject</span>(<span class="keyword">this</span>, &amp;ThisClass::OnFindSessionsComplete)),</span><br><span class="line">	<span class="built_in">JoinSessionCompleteDelegate</span>(FOnJoinSessionCompleteDelegate::<span class="built_in">CreateUObject</span>(<span class="keyword">this</span>, &amp;ThisClass::OnJoinSessionComplete)),</span><br><span class="line">	<span class="built_in">DestroySessionCompleteDelegate</span>(FOnDestroySessionCompleteDelegate::<span class="built_in">CreateUObject</span>(<span class="keyword">this</span>, &amp;ThisClass::OnDestroySessionComplete)),</span><br><span class="line">	<span class="built_in">StartSessionCompleteDelegate</span>(FOnStartSessionCompleteDelegate::<span class="built_in">CreateUObject</span>(<span class="keyword">this</span>, &amp;ThisClass::OnStartSessionComplete))</span><br><span class="line">&#123;</span><br><span class="line">	IOnlineSubsystem* Subsystem = IOnlineSubsystem::<span class="built_in">Get</span>();</span><br><span class="line">	<span class="keyword">if</span> (Subsystem) &#123;</span><br><span class="line">		SessionInterface = Subsystem-&gt;<span class="built_in">GetSessionInterface</span>();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UMultiplayerSessionsSubsystem::CreateSession</span><span class="params">(int32 NumPublicConnections, FString MatchType)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!SessionInterface.<span class="built_in">IsValid</span>()) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//如果有已经存在的会话，将其销毁</span></span><br><span class="line">	<span class="keyword">auto</span> ExistingSession = SessionInterface-&gt;<span class="built_in">GetNamedSession</span>(NAME_GameSession);</span><br><span class="line">	<span class="keyword">if</span> (ExistingSession) &#123;</span><br><span class="line">		bCreateSessionOnDestroy = <span class="literal">true</span>;</span><br><span class="line">		LastNumPublicConnections = NumPublicConnections;</span><br><span class="line">		LastMatchType = MatchType;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">DestroySession</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//将委托添加到列表，进行会话设置，创建会话。保存委托的句柄使我们之后可以从委托列表中将其移除。</span></span><br><span class="line">	CreateSessionCompleteDelegateHandle = SessionInterface-&gt;<span class="built_in">AddOnCreateSessionCompleteDelegate_Handle</span>(CreateSessionCompleteDelegate);</span><br><span class="line"></span><br><span class="line">	LastSessionSettings = <span class="built_in">MakeShareable</span>(<span class="keyword">new</span> <span class="built_in">FOnlineSessionSettings</span>());</span><br><span class="line">	LastSessionSettings-&gt;bIsLANMatch = IOnlineSubsystem::<span class="built_in">Get</span>()-&gt;<span class="built_in">GetSubsystemName</span>() == <span class="string">&quot;NULL&quot;</span>; <span class="comment">//是否为局域网匹配</span></span><br><span class="line">	LastSessionSettings-&gt;NumPublicConnections = NumPublicConnections; <span class="comment">//最大联机数量</span></span><br><span class="line">	LastSessionSettings-&gt;bAllowJoinInProgress = <span class="literal">true</span>; <span class="comment">//是否允许中途加入</span></span><br><span class="line">	LastSessionSettings-&gt;bAllowJoinViaPresence = <span class="literal">true</span>; <span class="comment">//是否允许通过 Steam 好友加入</span></span><br><span class="line">	LastSessionSettings-&gt;bShouldAdvertise = <span class="literal">true</span>; <span class="comment">//是否将房间暴露出去</span></span><br><span class="line">	LastSessionSettings-&gt;bUsesPresence = <span class="literal">true</span>; <span class="comment">//是否使用“在线状态系统”</span></span><br><span class="line">	LastSessionSettings-&gt;bUseLobbiesIfAvailable = <span class="literal">true</span>; <span class="comment">//是否使用 Steam Lobby 功能（新版UE需要启用这个功能才能创建会话）</span></span><br><span class="line">	LastSessionSettings-&gt;<span class="built_in">Set</span>(<span class="built_in">FName</span>(<span class="string">&quot;MatchType&quot;</span>), MatchType, EOnlineDataAdvertisementType::ViaOnlineServiceAndPing);</span><br><span class="line">	LastSessionSettings-&gt;BuildUniqueId = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> ULocalPlayer* LocalPlayer = <span class="built_in">GetWorld</span>()-&gt;<span class="built_in">GetFirstLocalPlayerFromController</span>();</span><br><span class="line">	<span class="keyword">if</span> (!SessionInterface-&gt;<span class="built_in">CreateSession</span>(*LocalPlayer-&gt;<span class="built_in">GetPreferredUniqueNetId</span>(), NAME_GameSession, *LastSessionSettings)) &#123;</span><br><span class="line">		SessionInterface-&gt;<span class="built_in">ClearOnCreateSessionCompleteDelegate_Handle</span>(CreateSessionCompleteDelegateHandle);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//广播我们的自定义委托</span></span><br><span class="line">		MultiplayerOnCreateSessionComplete.<span class="built_in">Broadcast</span>(<span class="literal">false</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UMultiplayerSessionsSubsystem::FindSessions</span><span class="params">(<span class="type">int</span> MaxSearchResults)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!SessionInterface.<span class="built_in">IsValid</span>()) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	FindSessionsCompleteDelegateHandle = SessionInterface-&gt;<span class="built_in">AddOnFindSessionsCompleteDelegate_Handle</span>(FindSessionsCompleteDelegate); <span class="comment">//保存句柄</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//会话搜索设置</span></span><br><span class="line">	LastSessionSearch = <span class="built_in">MakeShareable</span>(<span class="keyword">new</span> <span class="built_in">FOnlineSessionSearch</span>());</span><br><span class="line">	LastSessionSearch-&gt;MaxSearchResults = MaxSearchResults;</span><br><span class="line">	LastSessionSearch-&gt;bIsLanQuery = IOnlineSubsystem::<span class="built_in">Get</span>()-&gt;<span class="built_in">GetSubsystemName</span>() == <span class="string">&quot;NULL&quot;</span>;</span><br><span class="line">	LastSessionSearch-&gt;QuerySettings.<span class="built_in">Set</span>(SEARCH_PRESENCE, <span class="literal">true</span>, EOnlineComparisonOp::Equals);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//搜索会话。如果搜索失败，委托解绑并向菜单广播创建失败</span></span><br><span class="line">	<span class="type">const</span> ULocalPlayer* LocalPlayer = <span class="built_in">GetWorld</span>()-&gt;<span class="built_in">GetFirstLocalPlayerFromController</span>();</span><br><span class="line">	<span class="keyword">if</span> (!SessionInterface-&gt;<span class="built_in">FindSessions</span>(*LocalPlayer-&gt;<span class="built_in">GetPreferredUniqueNetId</span>(), LastSessionSearch.<span class="built_in">ToSharedRef</span>())) &#123;</span><br><span class="line">		SessionInterface-&gt;<span class="built_in">ClearOnFindSessionsCompleteDelegate_Handle</span>(FindSessionsCompleteDelegateHandle);</span><br><span class="line"></span><br><span class="line">		MultiplayerOnFindSessionsComplete.<span class="built_in">Broadcast</span>(<span class="built_in">TArray</span>&lt;FOnlineSessionSearchResult&gt;(), <span class="literal">false</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UMultiplayerSessionsSubsystem::JoinSessions</span><span class="params">(<span class="type">const</span> FOnlineSessionSearchResult&amp; SessionResult)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!SessionInterface.<span class="built_in">IsValid</span>()) &#123;</span><br><span class="line">		MultiplayerOnJoinSessionComplete.<span class="built_in">Broadcast</span>(EOnJoinSessionCompleteResult::UnknownError);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//保存句柄</span></span><br><span class="line">	JoinSessionCompleteDelegateHandle = SessionInterface-&gt;<span class="built_in">AddOnJoinSessionCompleteDelegate_Handle</span>(JoinSessionCompleteDelegate);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//通过在线会话接口加入会话，如果失败就委托解绑，广播加入会话失败</span></span><br><span class="line">	<span class="type">const</span> ULocalPlayer* LocalPlayer = <span class="built_in">GetWorld</span>()-&gt;<span class="built_in">GetFirstLocalPlayerFromController</span>();</span><br><span class="line">	<span class="keyword">if</span> (!SessionInterface-&gt;<span class="built_in">JoinSession</span>(*LocalPlayer-&gt;<span class="built_in">GetPreferredUniqueNetId</span>(), NAME_GameSession, SessionResult)) &#123;</span><br><span class="line">		SessionInterface-&gt;<span class="built_in">ClearOnJoinSessionCompleteDelegate_Handle</span>(JoinSessionCompleteDelegateHandle);</span><br><span class="line">		MultiplayerOnJoinSessionComplete.<span class="built_in">Broadcast</span>(EOnJoinSessionCompleteResult::UnknownError);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UMultiplayerSessionsSubsystem::DestroySession</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!SessionInterface.<span class="built_in">IsValid</span>()) &#123;</span><br><span class="line">		MultiplayerOnDestroySessionComplete.<span class="built_in">Broadcast</span>(<span class="literal">false</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	DestroySessionCompleteDelegateHandle = SessionInterface-&gt;<span class="built_in">AddOnDestroySessionCompleteDelegate_Handle</span>(DestroySessionCompleteDelegate);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!SessionInterface-&gt;<span class="built_in">DestroySession</span>(NAME_GameSession)) &#123;</span><br><span class="line">		SessionInterface-&gt;<span class="built_in">ClearOnDestroySessionCompleteDelegate_Handle</span>(DestroySessionCompleteDelegateHandle);</span><br><span class="line">		MultiplayerOnDestroySessionComplete.<span class="built_in">Broadcast</span>(<span class="literal">false</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UMultiplayerSessionsSubsystem::StartSession</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UMultiplayerSessionsSubsystem::OnCreateSessionComplete</span><span class="params">(FName SessionName, <span class="type">bool</span> bWasSuccessful)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (SessionInterface) &#123;</span><br><span class="line">		SessionInterface-&gt;<span class="built_in">ClearOnCreateSessionCompleteDelegate_Handle</span>(CreateSessionCompleteDelegateHandle);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	MultiplayerOnCreateSessionComplete.<span class="built_in">Broadcast</span>(bWasSuccessful);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UMultiplayerSessionsSubsystem::OnFindSessionsComplete</span><span class="params">(<span class="type">bool</span> bWasSuccessful)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (SessionInterface) &#123;</span><br><span class="line">		SessionInterface-&gt;<span class="built_in">ClearOnFindSessionsCompleteDelegate_Handle</span>(FindSessionsCompleteDelegateHandle);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//如果没有找到会话，返回失败</span></span><br><span class="line">	<span class="keyword">if</span> (LastSessionSearch-&gt;SearchResults.<span class="built_in">Num</span>() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">		MultiplayerOnFindSessionsComplete.<span class="built_in">Broadcast</span>(<span class="built_in">TArray</span>&lt;FOnlineSessionSearchResult&gt;(), <span class="literal">false</span>);</span><br><span class="line">		<span class="keyword">if</span> (GEngine) &#123;</span><br><span class="line">			GEngine-&gt;<span class="built_in">AddOnScreenDebugMessage</span>(</span><br><span class="line">				<span class="number">-1</span>,</span><br><span class="line">				<span class="number">1.f</span>,</span><br><span class="line">				FColor::Red,</span><br><span class="line">				<span class="built_in">FString</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Session not found!&quot;</span>))</span><br><span class="line">			);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">auto</span>&amp; Result : LastSessionSearch-&gt;SearchResults)</span><br><span class="line">	&#123;</span><br><span class="line">		Result.Session.SessionSettings.bUseLobbiesIfAvailable = <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	MultiplayerOnFindSessionsComplete.<span class="built_in">Broadcast</span>(LastSessionSearch-&gt;SearchResults, bWasSuccessful);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UMultiplayerSessionsSubsystem::OnJoinSessionComplete</span><span class="params">(FName SessionName, EOnJoinSessionCompleteResult::Type Result)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!SessionInterface) &#123;</span><br><span class="line">		SessionInterface-&gt;<span class="built_in">ClearOnJoinSessionCompleteDelegate_Handle</span>(JoinSessionCompleteDelegateHandle);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	MultiplayerOnJoinSessionComplete.<span class="built_in">Broadcast</span>(Result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UMultiplayerSessionsSubsystem::OnDestroySessionComplete</span><span class="params">(FName SessionName, <span class="type">bool</span> bWasSuccessful)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (SessionInterface) &#123;</span><br><span class="line">		SessionInterface-&gt;<span class="built_in">ClearOnDestroySessionCompleteDelegate_Handle</span>(DestroySessionCompleteDelegateHandle);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (bWasSuccessful &amp;&amp; bCreateSessionOnDestroy) &#123;</span><br><span class="line">		bCreateSessionOnDestroy = <span class="literal">false</span>;</span><br><span class="line">		<span class="built_in">CreateSession</span>(LastNumPublicConnections, LastMatchType);</span><br><span class="line">	&#125;</span><br><span class="line">	MultiplayerOnDestroySessionComplete.<span class="built_in">Broadcast</span>(bWasSuccessful);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UMultiplayerSessionsSubsystem::OnStartSessionComplete</span><span class="params">(FName SessionName, <span class="type">bool</span> bWasSuccessful)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Menu.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;CoreMinimal.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Blueprint/UserWidget.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Interfaces/OnlineSessionInterface.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Menu.generated.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="built_in">UCLASS</span>()</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MULTIPLAYERSESSIONS_API</span> UMenu : <span class="keyword">public</span> UUserWidget</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">GENERATED_BODY</span>()</span><br><span class="line">	</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">UFUNCTION</span>(BlueprintCallable)</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">MenuSetup</span><span class="params">(int32 NumberOfPublicConnections = <span class="number">4</span>, FString TypeOfMatch = FString(TEXT(<span class="string">&quot;FreeForAll&quot;</span>)), FString LobbyPath = FString(TEXT(<span class="string">&quot;/Game/ThirdPerson/Maps/Lobby&quot;</span>)))</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">Initialize</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">NativeDestruct</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// 绑定到MultiplayerSessionsSubsystem类的自定义委托的回调函数</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="built_in">UFUNCTION</span>()</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">OnCreateSession</span><span class="params">(<span class="type">bool</span> bWasSuccessful)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">OnFindSessions</span><span class="params">(<span class="type">const</span> TArray &lt;FOnlineSessionSearchResult&gt;&amp; SessionResults, <span class="type">bool</span> bWasSuccessful)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">OnJoinSession</span><span class="params">(EOnJoinSessionCompleteResult::Type Result)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UFUNCTION</span>()</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">OnDestroySession</span><span class="params">(<span class="type">bool</span> bWasSuccessful)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UFUNCTION</span>()</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">OnStartSession</span><span class="params">(<span class="type">bool</span> bWasSuccessful)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="built_in">UPROPERTY</span>(meta = (BindWidget))</span><br><span class="line">	<span class="keyword">class</span> <span class="title class_">UButton</span>* HostButton;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(meta = (BindWidget))</span><br><span class="line">	UButton* JoinButton;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UFUNCTION</span>()</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">HostButtonClicked</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UFUNCTION</span>()</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">JoinButtonClicked</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 去除菜单</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">MenuTearDown</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//处理所有在线会话功能的子系统</span></span><br><span class="line">	<span class="keyword">class</span> <span class="title class_">UMultiplayerSessionsSubsystem</span>* MultiplayerSessionsSubsystem;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//最大连接数，匹配类型，大厅路径</span></span><br><span class="line">	int32 NumPublicConnections&#123; <span class="number">4</span> &#125;;</span><br><span class="line">	FString MatchType&#123; <span class="built_in">TEXT</span>(<span class="string">&quot;FreeForAll&quot;</span>) &#125;;</span><br><span class="line">	FString PathToLobby&#123; <span class="built_in">TEXT</span>(<span class="string">&quot;&quot;</span>) &#125;;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Menu.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Menu.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Components/Button.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;MultiplayerSessionsSubsystem.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;OnlineSessionSettings.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;OnlineSubsystem.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UMenu::MenuSetup</span><span class="params">(int32 NumberOfPublicConnections, FString TypeOfMatch, FString LobbyPath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	PathToLobby = FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;%s?listen&quot;</span>), *LobbyPath);</span><br><span class="line">	NumPublicConnections = NumberOfPublicConnections;</span><br><span class="line">	MatchType = TypeOfMatch;</span><br><span class="line">	<span class="built_in">AddToViewport</span>();</span><br><span class="line">	<span class="built_in">SetVisibility</span>(ESlateVisibility::Visible);</span><br><span class="line">	<span class="comment">//SetFocus();</span></span><br><span class="line">	bIsFocusable = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">	UWorld* World = <span class="built_in">GetWorld</span>();</span><br><span class="line">	<span class="keyword">if</span> (World) &#123;</span><br><span class="line">		APlayerController* PlayerController = World-&gt;<span class="built_in">GetFirstPlayerController</span>();</span><br><span class="line">		<span class="keyword">if</span> (PlayerController) &#123;</span><br><span class="line">			FInputModeUIOnly InputModeData;</span><br><span class="line">			InputModeData.<span class="built_in">SetWidgetToFocus</span>(<span class="built_in">TakeWidget</span>());</span><br><span class="line">			InputModeData.<span class="built_in">SetLockMouseToViewportBehavior</span>(EMouseLockMode::DoNotLock);</span><br><span class="line">			PlayerController-&gt;<span class="built_in">SetInputMode</span>(InputModeData);</span><br><span class="line">			PlayerController-&gt;<span class="built_in">SetShowMouseCursor</span>(<span class="literal">true</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	UGameInstance* GameInstance = <span class="built_in">GetGameInstance</span>();</span><br><span class="line">	<span class="keyword">if</span> (GameInstance) &#123;</span><br><span class="line">		MultiplayerSessionsSubsystem = GameInstance-&gt;<span class="built_in">GetSubsystem</span>&lt;UMultiplayerSessionsSubsystem&gt;();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//绑定回调函数</span></span><br><span class="line">	<span class="keyword">if</span> (MultiplayerSessionsSubsystem) &#123;</span><br><span class="line">		MultiplayerSessionsSubsystem-&gt;MultiplayerOnCreateSessionComplete.<span class="built_in">AddDynamic</span>(<span class="keyword">this</span>, &amp;ThisClass::OnCreateSession);</span><br><span class="line">		MultiplayerSessionsSubsystem-&gt;MultiplayerOnFindSessionsComplete.<span class="built_in">AddUObject</span>(<span class="keyword">this</span>, &amp;ThisClass::OnFindSessions);</span><br><span class="line">		MultiplayerSessionsSubsystem-&gt;MultiplayerOnJoinSessionComplete.<span class="built_in">AddUObject</span>(<span class="keyword">this</span>, &amp;ThisClass::OnJoinSession);</span><br><span class="line">		MultiplayerSessionsSubsystem-&gt;MultiplayerOnDestroySessionComplete.<span class="built_in">AddDynamic</span>(<span class="keyword">this</span>, &amp;ThisClass::OnDestroySession);</span><br><span class="line">		MultiplayerSessionsSubsystem-&gt;MultiplayerOnStartSessionComplete.<span class="built_in">AddDynamic</span>(<span class="keyword">this</span>, &amp;ThisClass::OnStartSession);</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">UMenu::Initialize</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!Super::<span class="built_in">Initialize</span>()) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (HostButton) &#123;</span><br><span class="line">		HostButton-&gt;OnClicked.<span class="built_in">AddDynamic</span>(<span class="keyword">this</span>, &amp;ThisClass::HostButtonClicked);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (JoinButton) &#123;</span><br><span class="line">		JoinButton-&gt;OnClicked.<span class="built_in">AddDynamic</span>(<span class="keyword">this</span>, &amp;ThisClass::JoinButtonClicked);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UMenu::NativeDestruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">MenuTearDown</span>();</span><br><span class="line">	Super::<span class="built_in">NativeDestruct</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UMenu::OnCreateSession</span><span class="params">(<span class="type">bool</span> bWasSuccessful)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (bWasSuccessful) &#123;</span><br><span class="line">		<span class="keyword">if</span> (GEngine) &#123;</span><br><span class="line">			GEngine-&gt;<span class="built_in">AddOnScreenDebugMessage</span>(</span><br><span class="line">				<span class="number">-1</span>,</span><br><span class="line">				<span class="number">15.f</span>,</span><br><span class="line">				FColor::Yellow,</span><br><span class="line">				<span class="built_in">FString</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Session created successfully!&quot;</span>))</span><br><span class="line">			);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		UWorld* World = <span class="built_in">GetWorld</span>();</span><br><span class="line">		<span class="keyword">if</span> (World) &#123;</span><br><span class="line">			World-&gt;<span class="built_in">ServerTravel</span>(PathToLobby);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (GEngine) &#123;</span><br><span class="line">			GEngine-&gt;<span class="built_in">AddOnScreenDebugMessage</span>(</span><br><span class="line">				<span class="number">-1</span>,</span><br><span class="line">				<span class="number">15.f</span>,</span><br><span class="line">				FColor::Red,</span><br><span class="line">				<span class="built_in">FString</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Failed to create session!&quot;</span>))</span><br><span class="line">			);</span><br><span class="line">		&#125;</span><br><span class="line">		HostButton-&gt;<span class="built_in">SetIsEnabled</span>(<span class="literal">true</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UMenu::OnFindSessions</span><span class="params">(<span class="type">const</span> TArray&lt;FOnlineSessionSearchResult&gt;&amp; SessionResults, <span class="type">bool</span> bWasSuccessful)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!MultiplayerSessionsSubsystem) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//遍历搜索结果，如果找到了匹配的会话，直接通过接口加入会话</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; Result : SessionResults) &#123;</span><br><span class="line">		FString SettingsValue;</span><br><span class="line">		Result.Session.SessionSettings.<span class="built_in">Get</span>(<span class="built_in">FName</span>(<span class="string">&quot;MatchType&quot;</span>), SettingsValue);</span><br><span class="line">		<span class="keyword">if</span> (SettingsValue == MatchType) &#123;</span><br><span class="line">			</span><br><span class="line">			MultiplayerSessionsSubsystem-&gt;<span class="built_in">JoinSessions</span>(Result);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!bWasSuccessful || SessionResults.<span class="built_in">Num</span>() == <span class="number">0</span>) &#123;</span><br><span class="line">		JoinButton-&gt;<span class="built_in">SetIsEnabled</span>(<span class="literal">true</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UMenu::OnJoinSession</span><span class="params">(EOnJoinSessionCompleteResult::Type Result)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	IOnlineSubsystem* Subsystem = IOnlineSubsystem::<span class="built_in">Get</span>();</span><br><span class="line">	<span class="keyword">if</span> (Subsystem) &#123;</span><br><span class="line">		IOnlineSessionPtr SessionInterface = Subsystem-&gt;<span class="built_in">GetSessionInterface</span>();</span><br><span class="line">		<span class="keyword">if</span> (SessionInterface.<span class="built_in">IsValid</span>()) &#123;</span><br><span class="line">			FString Address;</span><br><span class="line">			SessionInterface-&gt;<span class="built_in">GetResolvedConnectString</span>(NAME_GameSession, Address);</span><br><span class="line">			<span class="keyword">if</span> (Address == <span class="built_in">FString</span>()) &#123;</span><br><span class="line">				<span class="keyword">if</span> (GEngine) &#123;</span><br><span class="line">					GEngine-&gt;<span class="built_in">AddOnScreenDebugMessage</span>(</span><br><span class="line">						<span class="number">-1</span>,</span><br><span class="line">						<span class="number">15.f</span>,</span><br><span class="line">						FColor::Red,</span><br><span class="line">						<span class="built_in">FString</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Address not found!&quot;</span>))</span><br><span class="line">					);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			APlayerController* PlayerController = <span class="built_in">GetGameInstance</span>()-&gt;<span class="built_in">GetFirstLocalPlayerController</span>();</span><br><span class="line">			<span class="keyword">if</span> (PlayerController) &#123;</span><br><span class="line">				PlayerController-&gt;<span class="built_in">ClientTravel</span>(Address, ETravelType::TRAVEL_Absolute);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (Result != EOnJoinSessionCompleteResult::Success) &#123;</span><br><span class="line">		JoinButton-&gt;<span class="built_in">SetIsEnabled</span>(<span class="literal">true</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UMenu::OnDestroySession</span><span class="params">(<span class="type">bool</span> bWasSuccessful)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UMenu::OnStartSession</span><span class="params">(<span class="type">bool</span> bWasSuccessful)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UMenu::HostButtonClicked</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">/*if (GEngine) &#123;</span></span><br><span class="line"><span class="comment">		GEngine-&gt;AddOnScreenDebugMessage(</span></span><br><span class="line"><span class="comment">			-1,</span></span><br><span class="line"><span class="comment">			15.f,</span></span><br><span class="line"><span class="comment">			FColor::Yellow,</span></span><br><span class="line"><span class="comment">			FString(TEXT(&quot;Host Button Clicked&quot;))</span></span><br><span class="line"><span class="comment">		)；</span></span><br><span class="line"><span class="comment">	&#125;*/</span></span><br><span class="line"></span><br><span class="line">	HostButton-&gt;<span class="built_in">SetIsEnabled</span>(<span class="literal">false</span>);</span><br><span class="line">	<span class="keyword">if</span> (MultiplayerSessionsSubsystem) &#123;</span><br><span class="line">		MultiplayerSessionsSubsystem-&gt;<span class="built_in">CreateSession</span>(NumPublicConnections, MatchType);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UMenu::JoinButtonClicked</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">/*if (GEngine) &#123;</span></span><br><span class="line"><span class="comment">		GEngine-&gt;AddOnScreenDebugMessage(</span></span><br><span class="line"><span class="comment">			-1,</span></span><br><span class="line"><span class="comment">			15.f,</span></span><br><span class="line"><span class="comment">			FColor::Yellow,</span></span><br><span class="line"><span class="comment">			FString(TEXT(&quot;Join Button Clicked&quot;))</span></span><br><span class="line"><span class="comment">		);</span></span><br><span class="line"><span class="comment">	&#125;*/</span></span><br><span class="line"></span><br><span class="line">	JoinButton-&gt;<span class="built_in">SetIsEnabled</span>(<span class="literal">false</span>);</span><br><span class="line">	<span class="keyword">if</span> (MultiplayerSessionsSubsystem) &#123;</span><br><span class="line">		MultiplayerSessionsSubsystem-&gt;<span class="built_in">FindSessions</span>(<span class="number">10000</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (GEngine) &#123;</span><br><span class="line">			GEngine-&gt;<span class="built_in">AddOnScreenDebugMessage</span>(</span><br><span class="line">				<span class="number">-1</span>,</span><br><span class="line">				<span class="number">15.f</span>,</span><br><span class="line">				FColor::Yellow,</span><br><span class="line">				<span class="built_in">FString</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;MultiplayerSessionsSubsystem not found!&quot;</span>))</span><br><span class="line">			);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UMenu::MenuTearDown</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">RemoveFromParent</span>();</span><br><span class="line">	UWorld* World = <span class="built_in">GetWorld</span>();</span><br><span class="line">	<span class="keyword">if</span> (World) &#123;</span><br><span class="line">		APlayerController* PlayerController = World-&gt;<span class="built_in">GetFirstPlayerController</span>();</span><br><span class="line">		<span class="keyword">if</span> (PlayerController) &#123;</span><br><span class="line">			FInputModeGameOnly InputModeData;</span><br><span class="line">			PlayerController-&gt;<span class="built_in">SetInputMode</span>(InputModeData);</span><br><span class="line">			PlayerController-&gt;<span class="built_in">SetShowMouseCursor</span>(<span class="literal">false</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://www.keshiki.top">Keshiki</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://www.keshiki.top/undefined/f18ea7eb.html">https://www.keshiki.top/undefined/f18ea7eb.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://www.keshiki.top" target="_blank">Keshiki's Blog</a>！</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="/img/avatar.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Keshiki</div><div class="author-info-description">我们的头脑比天空更辽阔.</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">11</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/yuun4g1"><i class="fab fa-github"></i><span>我的github</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">欢迎来到Keshiki领域~</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E3%80%90UE5%E3%80%91%E5%A4%9A%E4%BA%BA%E8%81%94%E6%9C%BATPS%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91%EF%BC%88%E4%B8%80%EF%BC%89-%E2%80%94%E2%80%94-%E5%88%B6%E4%BD%9C%E8%81%94%E6%9C%BA%E6%8F%92%E4%BB%B6"><span class="toc-number">1.</span> <span class="toc-text">【UE5】多人联机TPS游戏开发（一） ——  制作联机插件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E8%81%94%E6%9C%BA%E5%9F%BA%E7%A1%80"><span class="toc-number">1.1.</span> <span class="toc-text">1.联机基础</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E6%B5%8B%E8%AF%95%E5%B1%80%E5%9F%9F%E7%BD%91%E8%81%94%E6%9C%BA"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1 测试局域网联机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E4%BD%BF%E7%94%A8%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%B1%80%E5%9F%9F%E7%BD%91%E8%81%94%E6%9C%BA"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.2 使用代码实现局域网联机</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%B5%8B%E8%AF%95%E9%80%9A%E8%BF%87Steam%E8%BF%9B%E8%A1%8C%E8%81%94%E6%9C%BA"><span class="toc-number">1.2.</span> <span class="toc-text">2 测试通过Steam进行联机</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1 配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E8%8E%B7%E5%8F%96%E4%BC%9A%E8%AF%9D%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.2 获取会话接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E5%88%9B%E5%BB%BA%E4%BC%9A%E8%AF%9D"><span class="toc-number">1.2.3.</span> <span class="toc-text">2.3 创建会话</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E5%8A%A0%E5%85%A5%E4%BC%9A%E8%AF%9D"><span class="toc-number">1.2.4.</span> <span class="toc-text">2.4 加入会话</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%8F%92%E4%BB%B6%E5%88%B6%E4%BD%9C"><span class="toc-number">1.3.</span> <span class="toc-text">3.插件制作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1 配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E5%88%9B%E5%BB%BA%E8%87%AA%E5%B7%B1%E7%9A%84%E7%B1%BB"><span class="toc-number">1.3.2.</span> <span class="toc-text">3.2 创建自己的类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E5%88%9B%E5%BB%BA%E4%BC%9A%E8%AF%9D"><span class="toc-number">1.3.3.</span> <span class="toc-text">3.3 创建会话</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E5%8A%A0%E5%85%A5%E4%BC%9A%E8%AF%9D"><span class="toc-number">1.3.4.</span> <span class="toc-text">3.4 加入会话</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-%E9%94%80%E6%AF%81%E4%BC%9A%E8%AF%9D"><span class="toc-number">1.3.5.</span> <span class="toc-text">3.5 销毁会话</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-%E6%94%B6%E5%B0%BE"><span class="toc-number">1.3.6.</span> <span class="toc-text">3.6 收尾</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81"><span class="toc-number">1.4.</span> <span class="toc-text">4.完整代码</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/undefined/af2b6aaf.html" title="【UE5】多人联机TPS游戏开发（四） ——  延迟补偿">【UE5】多人联机TPS游戏开发（四） ——  延迟补偿</a><time datetime="2025-08-13T16:00:00.000Z" title="发表于 2025-08-14 00:00:00">2025-08-14</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/undefined/f9d4ce84.html" title="【UE5】多人联机TPS游戏开发（三） —— 射击游戏核心">【UE5】多人联机TPS游戏开发（三） —— 射击游戏核心</a><time datetime="2025-08-02T16:00:00.000Z" title="发表于 2025-08-03 00:00:00">2025-08-03</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/undefined/e6c9f323.html" title="【UE5】多人联机TPS游戏开发（二） —— 基础框架">【UE5】多人联机TPS游戏开发（二） —— 基础框架</a><time datetime="2025-07-16T16:00:00.000Z" title="发表于 2025-07-17 00:00:00">2025-07-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/undefined/f18ea7eb.html" title="【UE5】多人联机TPS游戏开发（一） ——  制作联机插件">【UE5】多人联机TPS游戏开发（一） ——  制作联机插件</a><time datetime="2025-07-04T16:00:00.000Z" title="发表于 2025-07-05 00:00:00">2025-07-05</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/undefined/9d1c9e1.html" title="【UE5】GAS学习记录 —— 入门">【UE5】GAS学习记录 —— 入门</a><time datetime="2025-05-25T04:00:00.000Z" title="发表于 2025-05-25 12:00:00">2025-05-25</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2024 - 2025 By Keshiki</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(() => {
  const loadMathjax = () => {
    if (!window.MathJax) {
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          tags: 'none',
        },
        chtml: {
          scale: 1.1
        },
        options: {
          enableMenu: true,
          renderActions: {
            findScript: [10, doc => {
              for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
                const display = !!node.type.match(/; *mode=display/)
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
                const text = document.createTextNode('')
                node.parentNode.replaceChild(text, node)
                math.start = {node: text, delim: '', n: 0}
                math.end = {node: text, delim: '', n: 0}
                doc.math.push(math)
              }
            }, '']
          }
        }
      }

      const script = document.createElement('script')
      script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
      script.id = 'MathJax-script'
      script.async = true
      document.head.appendChild(script)
    } else {
      MathJax.startup.document.state(0)
      MathJax.texReset()
      MathJax.typesetPromise()
    }
  }

  btf.addGlobalFn('encrypt', loadMathjax, 'mathjax')
  window.pjax ? loadMathjax() : window.addEventListener('load', loadMathjax)
})()</script></div><div class="aplayer no-destroy" data-id="4875655013" data-server="netease" data-type="playlist"   data-order="list" data-fixed="true" data-preload="auto" data-autoplay="false" data-mutex="true" ></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><div class="app-refresh" id="app-refresh" style="position: fixed;top: -2.2rem;left: 0;right: 0;z-index: 99999;padding: 0 1rem;font-size: 15px;height: 2.2rem;transition: all 0.3s ease;"><div class="app-refresh-wrap" style=" display: flex;color: #fff;height: 100%;align-items: center;justify-content: center;"><label>好像有什么动静</label><a href="javascript:void(0)" onclick="location.reload()"><span style="color: #fff;text-decoration: underline;cursor: pointer;">去看看</span></a></div></div><script>if ('serviceWorker' in navigator) {
if (navigator.serviceWorker.controller) {
navigator.serviceWorker.addEventListener('controllerchange', function() {
showNotification()
})
}
window.addEventListener('load', function() {
navigator.serviceWorker.register('/sw.js')
})
}
function showNotification() {
if (GLOBAL_CONFIG.Snackbar) {
var snackbarBg =
document.documentElement.getAttribute('data-theme') === 'light' ?
GLOBAL_CONFIG.Snackbar.bgLight :
GLOBAL_CONFIG.Snackbar.bgDark
var snackbarPos = GLOBAL_CONFIG.Snackbar.position
Snackbar.show({
text: '好像有什么动静',
backgroundColor: snackbarBg,
duration: 500000,
pos: snackbarPos,
actionText: '去看看',
actionTextColor: '#fff',
onActionClick: function(e) {
location.reload()
},
})
} else {
var showBg =
document.documentElement.getAttribute('data-theme') === 'light' ?
'#3b70fc' :
'#1f1f1f'
var cssText = `top: 0; background: ${showBg};`
document.getElementById('app-refresh').style.cssText = cssText
}
}</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div><!-- hexo injector body_end start --><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '1.5s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('flink-list-card');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__flipInY');
    arr[i].setAttribute('data-wow-duration', '3s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('flink-list-card');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__animated');
    arr[i].setAttribute('data-wow-duration', '3s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('article-sort-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__slideInRight');
    arr[i].setAttribute('data-wow-duration', '1.5s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('site-card');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__flipInY');
    arr[i].setAttribute('data-wow-duration', '3s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('site-card');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__animated');
    arr[i].setAttribute('data-wow-duration', '3s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script></div><script defer src="https://cdn.cbd.int/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://cdn.cbd.int/hexo-butterfly-wowjs/lib/wow_init.js"></script><script async src="/js/ali_font.js"></script><!-- hexo injector body_end end --><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/"});</script></body></html>